<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-CN" lang="zh-CN">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>Active Support 核心扩展 — Ruby on Rails 指南</title>
<link rel="stylesheet" type="text/css" href="stylesheets/style.css" />
<link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print" />

<link rel="stylesheet" type="text/css" href="stylesheets/syntaxhighlighter/shCore.css" />
<link rel="stylesheet" type="text/css" href="stylesheets/syntaxhighlighter/shThemeRailsGuides.css" />

<link rel="stylesheet" type="text/css" href="stylesheets/fixes.css" />

<link href="images/favicon.ico" rel="shortcut icon" type="image/x-icon" />
</head>
<body class="guide">
  <div id="topNav">
    <div class="wrapper">
      <strong class="more-info-label">更多内容 <a href="http://rubyonrails.org/">rubyonrails.org:</a> </strong>
      <span class="red-button more-info-button">
        更多内容
      </span>
      <ul class="more-info-links s-hidden">
        <li class="more-info"><a href="http://rubyonrails.org/">综览</a></li>
        <li class="more-info"><a href="http://rubyonrails.org/download">下载</a></li>
        <li class="more-info"><a href="http://rubyonrails.org/deploy">部署</a></li>
        <li class="more-info"><a href="https://github.com/rails/rails">源码</a></li>
        <li class="more-info"><a href="http://rubyonrails.org/screencasts">视频</a></li>
        <li class="more-info"><a href="http://rubyonrails.org/documentation">文件</a></li>
        <li class="more-info"><a href="http://rubyonrails.org/community">社群</a></li>
        <li class="more-info"><a href="http://weblog.rubyonrails.org/">Blog</a></li>
      </ul>
    </div>
  </div>
  <div id="header">
    <div class="wrapper clearfix">
      <h1><a href="index.html" title="回首页">Guides.rubyonrails.org</a></h1>
      <ul class="nav">
        <li><a class="nav-item" href="index.html">首页</a></li>
        <li class="guides-index guides-index-large">
          <a href="index.html" id="guidesMenu" class="guides-index-item nav-item">指南目录</a>
          <div id="guides" class="clearfix" style="display: none;">
            <hr />
              <dl class="L">
                <dt>入门</dt>
                <dd><a href="getting_started.html">Rails 入门</a></dd>
                <dt>模型</dt>
                <dd><a href="active_record_basics.html">Active Record 基础</a></dd>
                <dd><a href="active_record_migrations.html">Active Record 数据库迁移</a></dd>
                <dd><a href="active_record_validations.html">Active Record 数据验证</a></dd>
                <dd><a href="active_record_callbacks.html">Active Record 回调</a></dd>
                <dd><a href="association_basics.html">Active Record 关联</a></dd>
                <dd><a href="active_record_querying.html">Active Record 查询</a></dd>
                <dt>视图</dt>
                <dd><a href="layouts_and_rendering.html">Rails 布局和视图渲染</a></dd>
                <dd><a href="form_helpers.html">Action View 表单帮助方法</a></dd>
                <dt>控制器</dt>
                <dd><a href="action_controller_overview.html">Action Controller 简介</a></dd>
                <dd><a href="routing.html">Rails 路由全解</a></dd>
              </dl>
              <dl class="R">
                <dt>深入</dt>
                <dd><a href="active_support_core_extensions.html">Active Support 核心扩展</a></dd>
                <dd><a href="i18n.html">Rails 国际化 API</a></dd>
                <dd><a href="action_mailer_basics.html">Action Mailer 基础</a></dd>
                <dd><a href="active_job_basics.html">Active Job 基础</a></dd>
                <dd><a href="security.html">Rails 安全指南</a></dd>
                <dd><a href="debugging_rails_applications.html">调试 Rails 程序</a></dd>
                <dd><a href="configuring.html">设置 Rails 程序</a></dd>
                <dd><a href="command_line.html">Rails 命令行</a></dd>
                <dd><a href="asset_pipeline.html">Asset Pipeline</a></dd>
                <dd><a href="working_with_javascript_in_rails.html">在 Rails 中使用 JavaScript</a></dd>
                <dd><a href="constant_autoloading_and_reloading.html">Constant Autoloading and Reloading</a></dd>
                <dt>扩展 Rails</dt>
                <dd><a href="rails_on_rack.html">Rails on Rack</a></dd>
                <dd><a href="generators.html">客制与新建 Rails 产生器</a></dd>
                <dd><a href="rails_application_templates.html">Rails 应用程式模版</a></dd>
                <dt>贡献 Ruby on Rails</dt>
                <dd><a href="contributing_to_ruby_on_rails.html">贡献 Ruby on Rails</a></dd>
                <dd><a href="api_documentation_guidelines.html">API 文件准则</a></dd>
                <dd><a href="ruby_on_rails_guides_guidelines.html">Ruby on Rails 指南准则</a></dd>
                <dt>维护方针</dt>
                <dd><a href="maintenance_policy.html">维护方针</a></dd>
                <dt>发布记</dt>
                <dd><a href="upgrading_ruby_on_rails.html">升级 Ruby on Rails</a></dd>
                <dd><a href="4_2_release_notes.html">Ruby on Rails 4.2 发布记</a></dd>
                <dd><a href="4_1_release_notes.html">Ruby on Rails 4.1 发布记</a></dd>
                <dd><a href="4_0_release_notes.html">Ruby on Rails 4.0 发布记</a></dd>
                <dd><a href="3_2_release_notes.html">Ruby on Rails 3.2 发布记</a></dd>
                <dd><a href="3_1_release_notes.html">Ruby on Rails 3.1 发布记</a></dd>
                <dd><a href="3_0_release_notes.html">Ruby on Rails 3.0 发布记</a></dd>
                <dd><a href="2_3_release_notes.html">Ruby on Rails 2.3 发布记</a></dd>
                <dd><a href="2_2_release_notes.html">Ruby on Rails 2.2 发布记</a></dd>
              </dl>
          </div>
        </li>
        <!-- <li><a class="nav-item" href="//github.com/docrails-tw/wiki">参与翻译</a></li> -->
        <li><a class="nav-item" href="https://github.com/ruby-china/guides/blob/master/CONTRIBUTING.md">贡献</a></li>
        <li><a class="nav-item" href="credits.html">致谢</a></li>
        <li class="guides-index guides-index-small">
          <select class="guides-index-item nav-item">
            <option value="index.html">指南目录</option>
              <optgroup label="入门">
                  <option value="getting_started.html">Rails 入门</option>
              </optgroup>
              <optgroup label="模型">
                  <option value="active_record_basics.html">Active Record 基础</option>
                  <option value="active_record_migrations.html">Active Record 数据库迁移</option>
                  <option value="active_record_validations.html">Active Record 数据验证</option>
                  <option value="active_record_callbacks.html">Active Record 回调</option>
                  <option value="association_basics.html">Active Record 关联</option>
                  <option value="active_record_querying.html">Active Record 查询</option>
              </optgroup>
              <optgroup label="视图">
                  <option value="layouts_and_rendering.html">Rails 布局和视图渲染</option>
                  <option value="form_helpers.html">Action View 表单帮助方法</option>
              </optgroup>
              <optgroup label="控制器">
                  <option value="action_controller_overview.html">Action Controller 简介</option>
                  <option value="routing.html">Rails 路由全解</option>
              </optgroup>
              <optgroup label="深入">
                  <option value="active_support_core_extensions.html">Active Support 核心扩展</option>
                  <option value="i18n.html">Rails 国际化 API</option>
                  <option value="action_mailer_basics.html">Action Mailer 基础</option>
                  <option value="active_job_basics.html">Active Job 基础</option>
                  <option value="security.html">Rails 安全指南</option>
                  <option value="debugging_rails_applications.html">调试 Rails 程序</option>
                  <option value="configuring.html">设置 Rails 程序</option>
                  <option value="command_line.html">Rails 命令行</option>
                  <option value="asset_pipeline.html">Asset Pipeline</option>
                  <option value="working_with_javascript_in_rails.html">在 Rails 中使用 JavaScript</option>
                  <option value="constant_autoloading_and_reloading.html">Constant Autoloading and Reloading</option>
              </optgroup>
              <optgroup label="扩展 Rails">
                  <option value="rails_on_rack.html">Rails on Rack</option>
                  <option value="generators.html">客制与新建 Rails 产生器</option>
                  <option value="rails_application_templates.html">Rails 应用程式模版</option>
              </optgroup>
              <optgroup label="贡献 Ruby on Rails">
                  <option value="contributing_to_ruby_on_rails.html">贡献 Ruby on Rails</option>
                  <option value="api_documentation_guidelines.html">API 文件准则</option>
                  <option value="ruby_on_rails_guides_guidelines.html">Ruby on Rails 指南准则</option>
              </optgroup>
              <optgroup label="维护方针">
                  <option value="maintenance_policy.html">维护方针</option>
              </optgroup>
              <optgroup label="发布记">
                  <option value="upgrading_ruby_on_rails.html">升级 Ruby on Rails</option>
                  <option value="4_2_release_notes.html">Ruby on Rails 4.2 发布记</option>
                  <option value="4_1_release_notes.html">Ruby on Rails 4.1 发布记</option>
                  <option value="4_0_release_notes.html">Ruby on Rails 4.0 发布记</option>
                  <option value="3_2_release_notes.html">Ruby on Rails 3.2 发布记</option>
                  <option value="3_1_release_notes.html">Ruby on Rails 3.1 发布记</option>
                  <option value="3_0_release_notes.html">Ruby on Rails 3.0 发布记</option>
                  <option value="2_3_release_notes.html">Ruby on Rails 2.3 发布记</option>
                  <option value="2_2_release_notes.html">Ruby on Rails 2.2 发布记</option>
              </optgroup>
          </select>
        </li>
      </ul>
      </div>
    </div>
  </div>
  <hr class="hide" />

  <div id="feature">
    <div class="wrapper">
      <h2>Active Support 核心扩展</h2><p>Active Support 作为 Ruby on Rails 的一个组件，可以用来添加 Ruby 语言扩展、工具集以及其他这类事物。</p><p>它从语言的层面上进行了强化，既可起效于一般 Rails 程序开发，又能增强 Ruby on Rails 框架自身。</p><p>读完本文，你将学到：</p>
<ul>
<li>核心扩展是什么。</li>
<li>如何加载全部扩展。</li>
<li>如何恰如其分的选出你需要的扩展。</li>
<li>Active Support 都提供了哪些功能。</li>
</ul>


                <div id="subCol">
            <h3 class="chapter"><img src="images/chapters_icon.gif" alt="" />Chapters</h3>
            <ol class="chapters">
<li>
<a href="#%E5%A6%82%E4%BD%95%E5%8A%A0%E8%BD%BD%E6%A0%B8%E5%BF%83%E6%89%A9%E5%B1%95">如何加载核心扩展</a>

<ul>
<li><a href="#%E5%8D%95%E7%8B%AC%E7%9A%84-active-support">单独的 Active Support</a></li>
<li><a href="#ruby-on-rails-%E7%A8%8B%E5%BA%8F%E9%87%8C%E7%9A%84-active-support">Ruby on Rails 程序里的 Active Support</a></li>
</ul>
</li>
<li>
<a href="#%E6%89%80%E6%9C%89%E5%AF%B9%E8%B1%A1%E9%83%BD%E5%8F%AF%E7%94%A8%E7%9A%84%E6%89%A9%E5%B1%95">所有对象都可用的扩展</a>

<ul>
<li><a href="#blank-questionmark-and-present-questionmark"><code>blank?</code> and <code>present?</code></a></li>
<li><a href="#presence"><code>presence</code></a></li>
<li><a href="#duplicable-questionmark"><code>duplicable?</code></a></li>
<li><a href="#deep_dup"><code>deep_dup</code></a></li>
<li><a href="#try"><code>try</code></a></li>
<li><a href="#class_eval(*args,-&amp;block)"><code>class_eval(*args, &amp;block)</code></a></li>
<li><a href="#acts_like-questionmark(duck)"><code>acts_like?(duck)</code></a></li>
<li><a href="#to_param"><code>to_param</code></a></li>
<li><a href="#to_query"><code>to_query</code></a></li>
<li><a href="#with_options"><code>with_options</code></a></li>
<li><a href="#json-%E6%94%AF%E6%8C%81">JSON 支持</a></li>
<li><a href="#%E5%AE%9E%E4%BE%8B%E5%8F%98%E9%87%8F">实例变量</a></li>
<li><a href="#silencing-warnings,-streams,-%E5%92%8C-exceptions">Silencing Warnings, Streams, 和 Exceptions</a></li>
<li><a href="#in-questionmark"><code>in?</code></a></li>
</ul>
</li>
<li>
<a href="#%E5%AF%B9module%E7%9A%84%E6%89%A9%E5%B1%95">对<code>Module</code>的扩展</a>

<ul>
<li><a href="#alias_method_chain"><code>alias_method_chain</code></a></li>
<li><a href="#%E5%B1%9E%E6%80%A7">属性</a></li>
<li><a href="#%E5%AF%B9module%E7%9A%84%E6%89%A9%E5%B1%95-parents">Parents</a></li>
<li><a href="#%E5%B8%B8%E9%87%8F">常量</a></li>
<li><a href="#reachable">Reachable</a></li>
<li><a href="#anonymous">Anonymous</a></li>
<li><a href="#method-delegation">Method Delegation</a></li>
<li><a href="#redefining-methods">Redefining Methods</a></li>
</ul>
</li>
<li>
<a href="#extensions-to-class">Extensions to <code>Class</code></a>

<ul>
<li><a href="#class-attributes">Class Attributes</a></li>
<li><a href="#subclasses-&amp;-descendants">Subclasses &amp; Descendants</a></li>
</ul>
</li>
<li>
<a href="#extensions-to-string">Extensions to <code>String</code></a>

<ul>
<li><a href="#output-safety">Output Safety</a></li>
<li><a href="#remove"><code>remove</code></a></li>
<li><a href="#squish"><code>squish</code></a></li>
<li><a href="#truncate"><code>truncate</code></a></li>
<li><a href="#inquiry"><code>inquiry</code></a></li>
<li><a href="#starts_with-questionmark-and-ends_with-questionmark"><code>starts_with?</code> and <code>ends_with?</code></a></li>
<li><a href="#strip_heredoc"><code>strip_heredoc</code></a></li>
<li><a href="#indent"><code>indent</code></a></li>
<li><a href="#access">Access</a></li>
<li><a href="#inflections">Inflections</a></li>
<li><a href="#extensions-to-string-conversions">Conversions</a></li>
</ul>
</li>
<li>
<a href="#extensions-to-numeric">Extensions to <code>Numeric</code></a>

<ul>
<li><a href="#bytes">Bytes</a></li>
<li><a href="#time">Time</a></li>
<li><a href="#formatting">Formatting</a></li>
</ul>
</li>
<li>
<a href="#extensions-to-integer">Extensions to <code>Integer</code></a>

<ul>
<li><a href="#multiple_of-questionmark"><code>multiple_of?</code></a></li>
<li><a href="#ordinal"><code>ordinal</code></a></li>
<li><a href="#ordinalize"><code>ordinalize</code></a></li>
</ul>
</li>
<li>
<a href="#extensions-to-bigdecimal">Extensions to <code>BigDecimal</code></a>

<ul>
<li><a href="#extensions-to-bigdecimal-to_s"><code>to_s</code></a></li>
<li><a href="#extensions-to-bigdecimal-to_formatted_s"><code>to_formatted_s</code></a></li>
</ul>
</li>
<li>
<a href="#extensions-to-enumerable">Extensions to <code>Enumerable</code></a>

<ul>
<li><a href="#sum"><code>sum</code></a></li>
<li><a href="#index_by"><code>index_by</code></a></li>
<li><a href="#many-questionmark"><code>many?</code></a></li>
<li><a href="#exclude-questionmark"><code>exclude?</code></a></li>
</ul>
</li>
<li>
<a href="#extensions-to-array">Extensions to <code>Array</code></a>

<ul>
<li><a href="#accessing">Accessing</a></li>
<li><a href="#adding-elements">Adding Elements</a></li>
<li><a href="#options-extraction">Options Extraction</a></li>
<li><a href="#extensions-to-array-conversions">Conversions</a></li>
<li><a href="#wrapping">Wrapping</a></li>
<li><a href="#duplicating">Duplicating</a></li>
<li><a href="#grouping">Grouping</a></li>
</ul>
</li>
<li>
<a href="#extensions-to-hash">Extensions to <code>Hash</code></a>

<ul>
<li><a href="#extensions-to-hash-conversions">Conversions</a></li>
<li><a href="#merging">Merging</a></li>
<li><a href="#deep-duplicating">Deep duplicating</a></li>
<li><a href="#working-with-keys">Working with Keys</a></li>
<li><a href="#slicing">Slicing</a></li>
<li><a href="#extracting">Extracting</a></li>
<li><a href="#indifferent-access">Indifferent Access</a></li>
<li><a href="#compacting">Compacting</a></li>
</ul>
</li>
<li>
<a href="#extensions-to-regexp">Extensions to <code>Regexp</code></a>

<ul>
<li><a href="#multiline-questionmark"><code>multiline?</code></a></li>
</ul>
</li>
<li>
<a href="#extensions-to-range">Extensions to <code>Range</code></a>

<ul>
<li><a href="#extensions-to-range-to_s"><code>to_s</code></a></li>
<li><a href="#include-questionmark"><code>include?</code></a></li>
<li><a href="#overlaps-questionmark"><code>overlaps?</code></a></li>
</ul>
</li>
<li>
<a href="#extensions-to-proc">Extensions to <code>Proc</code></a>

<ul>
<li><a href="#bind"><code>bind</code></a></li>
</ul>
</li>
<li>
<a href="#extensions-to-date">Extensions to <code>Date</code></a>

<ul>
<li><a href="#extensions-to-date-calculations">Calculations</a></li>
<li><a href="#extensions-to-date-conversions">Conversions</a></li>
</ul>
</li>
<li>
<a href="#extensions-to-datetime">Extensions to <code>DateTime</code></a>

<ul>
<li><a href="#extensions-to-datetime-calculations">Calculations</a></li>
</ul>
</li>
<li>
<a href="#extensions-to-time">Extensions to <code>Time</code></a>

<ul>
<li><a href="#calculations">Calculations</a></li>
<li><a href="#time-constructors">Time Constructors</a></li>
</ul>
</li>
<li>
<a href="#extensions-to-file">Extensions to <code>File</code></a>

<ul>
<li><a href="#atomic_write"><code>atomic_write</code></a></li>
</ul>
</li>
<li>
<a href="#extensions-to-marshal">Extensions to <code>Marshal</code></a>

<ul>
<li><a href="#load"><code>load</code></a></li>
</ul>
</li>
<li>
<a href="#extensions-to-logger">Extensions to <code>Logger</code></a>

<ul>
<li><a href="#around_%5Blevel%5D"><code>around_[level]</code></a></li>
<li><a href="#silence"><code>silence</code></a></li>
<li><a href="#datetime_format="><code>datetime_format=</code></a></li>
</ul>
</li>
<li><a href="#extensions-to-nameerror">Extensions to <code>NameError</code></a></li>
<li><a href="#extensions-to-loaderror">Extensions to <code>LoadError</code></a></li>
</ol>

          </div>

    </div>
  </div>

  <div id="container">
    <div class="wrapper">
      <div id="mainCol">
        <h3 id="如何加载核心扩展">1 如何加载核心扩展</h3><h4 id="单独的-active-support">1.1 单独的 Active Support</h4><p>为了使初始空间尽可能干净，默认情况下 Active Support 什么都不加载。它被拆分成许多小组件，这样一来你便可以只加载自己需要的那部分，同时它也提供了一系列便捷入口使你很容易加载相关的扩展，甚至把全部扩展都加载进来。</p><p>因而，像下面这样只简单用一个 require：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
require 'active_support'

</pre>
</div>
<p>对象会连<code>blank?</code>都没法响应。让我们来看下该如何加载它的定义。</p><h5 id="选出合适的定义">1.1.1 选出合适的定义</h5><p>找到<code>blank?</code>最轻便的方法就是直接找出定义它的那个文件。</p><p>对于每一个定义在核心扩展里的方法，本指南都会注明此方法定义于何处。例如这里提到的<code>blank?</code>，会像这样注明：</p><div class="note"><p>定义于 <code>active_support/core_ext/object/blank.rb</code>。</p></div><p>这意味着你可以像下面这样 require 它：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
require 'active_support'
require 'active_support/core_ext/object/blank'

</pre>
</div>
<p>Active Support 经过了严格的修订，确保选定的文件只会加载必要的依赖，若没有则不加载。</p><h5 id="加载一组核心扩展">1.1.2 加载一组核心扩展</h5><p>接下来加载<code>Object</code>下的全部扩展。一般来说，想加载<code>SomeClass</code>下的全部可用扩展，只需加载<code>active_support/core_ext/some_class</code>即可。</p><p>所以，若要加载<code>Object</code>下的全部扩展（包含<code>blank?</code>）：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
require 'active_support'
require 'active_support/core_ext/object'

</pre>
</div>
<h5 id="加载全部核心扩展">1.1.3 加载全部核心扩展</h5><p>你可能更倾向于加载全部核心扩展，有一个文件能办到：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
require 'active_support'
require 'active_support/core_ext'

</pre>
</div>
<h5 id="加载全部-active-support">1.1.4 加载全部 Active Support</h5><p>最后，如果你想要 Active Support 的全部内容，只需：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
require 'active_support/all'

</pre>
</div>
<p>这样做并不会把整个 Active Support 预加载到内存里，鉴于<code>autoload</code>的机制，其只有在真正用到时才会加载。</p><h4 id="ruby-on-rails-程序里的-active-support">1.2 Ruby on Rails 程序里的 Active Support</h4><p>除非把<code>config.active_support.bare</code>设置为 true, 否则 Ruby on Rails 的程序会加载全部的 Active Support。如此一来，程序只会加载框架为自身需要挑选出来的扩展，同时也可像上文所示，可以从任何级别加载特定扩展。</p><h3 id="所有对象都可用的扩展">2 所有对象都可用的扩展</h3><h4 id="blank-questionmark-and-present-questionmark">2.1 <code>blank?</code> and <code>present?</code>
</h4><p>以下各值在 Rails 程序里都看作 blank。</p>
<ul>
<li><p><code>nil</code> 和 <code>false</code>，</p></li>
<li><p>只包含空白的字符串(参照下文注释),</p></li>
<li><p>空的数组和散列表</p></li>
<li><p>任何其他能响应 <code>empty?</code> 方法且为空的对象。</p></li>
</ul>
<div class="info"><p>判断字符串是否为空依据了 Unicode-aware 字符类 <code>[:space:]</code>，所以例如 U+2029（段落分隔符）这种会被当作空白。</p></div><div class="warning"><p>注意这里没有提到数字。通常来说，0和0.0都<strong>不是</strong>blank。</p></div><p>例如，<code>ActionController::HttpAuthentication::Token::ControllerMethods</code>里的一个方法使用了<code>blank?</code>来检验 token 是否存在。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
def authenticate(controller, &amp;login_procedure)
  token, options = token_and_options(controller.request)
  unless token.blank?
    login_procedure.call(token, options)
  end
end

</pre>
</div>
<p><code>present?</code> 方法等同于 <code>!blank?</code>， 下面的例子出自<code>ActionDispatch::Http::Cache::Response</code>：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
def set_conditional_cache_control!
  return if self["Cache-Control"].present?
  ...
end

</pre>
</div>
<div class="note"><p>定义于 <code>active_support/core_ext/object/blank.rb</code>.</p></div><h4 id="presence">2.2 <code>presence</code>
</h4><p><code>presence</code>方法如果满足<code>present?</code>则返回调用者，否则返回<code>nil</code>。它适用于下面这种情况：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
host = config[:host].presence || 'localhost'

</pre>
</div>
<div class="note"><p>定义于 <code>active_support/core_ext/object/blank.rb</code>.</p></div><h4 id="duplicable-questionmark">2.3 <code>duplicable?</code>
</h4><p>A few fundamental objects in Ruby are singletons. For example, in the whole life of a program the integer 1 refers always to the same instance:
Ruby 里有些基本对象是单例的。比如，在整个程序的生命周期里，数字1永远指向同一个实例。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
1.object_id                 # =&gt; 3
Math.cos(0).to_i.object_id  # =&gt; 3

</pre>
</div>
<p>因而，这些对象永远没法用<code>dup</code>或<code>clone</code>复制。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
true.dup  # =&gt; TypeError: can't dup TrueClass

</pre>
</div>
<p>有些数字虽然不是单例的，但也同样无法复制：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
0.0.clone        # =&gt; allocator undefined for Float
(2**1024).clone  # =&gt; allocator undefined for Bignum

</pre>
</div>
<p>Active Support 提供了 <code>duplicable?</code> 方法来判断一个对象是否能够被复制:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"foo".duplicable? # =&gt; true
"".duplicable?    # =&gt; true
0.0.duplicable?   # =&gt; false
false.duplicable? # =&gt; false

</pre>
</div>
<p>根据定义，所有的对象的<code>duplicated?</code>的，除了：<code>nil</code>、<code>false</code>、 <code>true</code>、 符号、 数字、 类和模块。</p><div class="warning"><p>任何的类都可以通过移除<code>dup</code>和<code>clone</code>方法，或者在其中抛出异常，来禁用其复制功能。虽然<code>duplicable?</code>方法是基于上面的硬编码列表，但是它比用<code>rescue</code>快的多。确保仅在你的情况合乎上面的硬编码列表时候再使用它。</p></div><div class="note"><p>定义于 <code>active_support/core_ext/object/duplicable.rb</code>.</p></div><h4 id="deep_dup">2.4 <code>deep_dup</code>
</h4><p><code>deep_dup</code>方法返回一个对象的深度拷贝。一般来说，当你<code>dup</code>一个包含其他对象的对象时，Ruby 并不会把被包含的对象一同<code>dup</code>，它只会创建一个对象的浅表拷贝。假如你有一个字符串数组，如下例所示：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
array     = ['string']
duplicate = array.dup

duplicate.push 'another-string'

# 对象被复制了，所以只有 duplicate 的数组元素有所增加
array     # =&gt; ['string']
duplicate # =&gt; ['string', 'another-string']

duplicate.first.gsub!('string', 'foo')

# 第一个数组元素并未被复制，所以两个数组都发生了变化
array     # =&gt; ['foo']
duplicate # =&gt; ['foo', 'another-string']

</pre>
</div>
<p>如你所见，对<code>Array</code>实例进行复制后，我们得到了另一个对象，因而我们修改它时，原始对象并未跟着有所变化。不过对数组元素而言，情况却有所不同。因为<code>dup</code>不会创建深度拷贝，所以数组里的字符串依然是同一个对象。</p><p>如果你需要一个对象的深度拷贝，就应该使用<code>deep_dup</code>。我们再来看下面这个例子：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
array     = ['string']
duplicate = array.deep_dup

duplicate.first.gsub!('string', 'foo')

array     # =&gt; ['string']
duplicate # =&gt; ['foo']

</pre>
</div>
<p>如果一个对象是不可复制的，<code>deep_dup</code>会返回其自身：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
number = 1
duplicate = number.deep_dup
number.object_id == duplicate.object_id   # =&gt; true

</pre>
</div>
<div class="note"><p>定义于 <code>active_support/core_ext/object/deep_dup.rb</code>.</p></div><h4 id="try">2.5 <code>try</code>
</h4><p>如果你想在一个对象不为<code>nil</code>时，对其调用一个方法，最简单的办法就是使用条件从句，但这么做也会使代码变得乱七八糟。另一个选择就是使用<code>try</code>。<code>try</code>就好比<code>Object#send</code>，只不过如果接收者为<code>nil</code>，那么返回值也会是<code>nil</code>。</p><p>看下这个例子：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# 不使用 try
unless @number.nil?
  @number.next
end

# 使用 try
@number.try(:next)

</pre>
</div>
<p>接下来的这个例子，代码出自<code>ActiveRecord::ConnectionAdapters::AbstractAdapter</code>，这里的<code>@logger</code>有可能为<code>nil</code>。能够看到，代码里使用了<code>try</code>来避免不必要的检查。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
def log_info(sql, name, ms)
  if @logger.try(:debug?)
    name = '%s (%.1fms)' % [name || 'SQL', ms]
    @logger.debug(format_log_entry(name, sql.squeeze(' ')))
  end
end

</pre>
</div>
<p>调用<code>try</code>时也可以不传参数而是用代码快，其中的代码只有在对象不为<code>nil</code>时才会执行：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
@person.try { |p| "#{p.first_name} #{p.last_name}" }

</pre>
</div>
<div class="note"><p>定义于 <code>active_support/core_ext/object/try.rb</code>.</p></div><h4 id="class_eval(*args,-&amp;block)">2.6 <code>class_eval(*args, &amp;block)</code>
</h4><p>You can evaluate code in the context of any object's singleton class using <code>class_eval</code>:
使用<code>class_eval</code>，可以使代码在对象的单件类的上下文里执行：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class Proc
  def bind(object)
    block, time = self, Time.current
    object.class_eval do
      method_name = "__bind_#{time.to_i}_#{time.usec}"
      define_method(method_name, &amp;block)
      method = instance_method(method_name)
      remove_method(method_name)
      method
    end.bind(object)
  end
end

</pre>
</div>
<div class="note"><p>定义于 <code>active_support/core_ext/kernel/singleton_class.rb</code>.</p></div><h4 id="acts_like-questionmark(duck)">2.7 <code>acts_like?(duck)</code>
</h4><p><code>acts_like?</code>方法可以用来判断某个类与另一个类是否有相同的行为，它基于一个简单的惯例：这个类是否提供了与<code>String</code>相同的接口：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
def acts_like_string?
end

</pre>
</div>
<p>上述代码只是一个标识，它的方法体或返回值都是不相关的。之后，就可以像下述代码那样判断其代码是否为“鸭子类型安全”的代码了：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
some_klass.acts_like?(:string)

</pre>
</div>
<p>Rails 里的许多类，例如<code>Date</code>和<code>Time</code>，都遵循上述约定。</p><div class="note"><p>定义于 <code>active_support/core_ext/object/acts_like.rb</code>.</p></div><h4 id="to_param">2.8 <code>to_param</code>
</h4><p>所有 Rails 对象都可以响应<code>to_param</code>方法，它会把对象的值转换为查询字符串，或者 URL 片段，并返回该值。</p><p>默认情况下，<code>to_param</code>仅仅调用了<code>to_s</code>：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
7.to_param # =&gt; "7"

</pre>
</div>
<p><strong>不要</strong>对<code>to_param</code>方法的返回值进行转义：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"Tom &amp; Jerry".to_param # =&gt; "Tom &amp; Jerry"

</pre>
</div>
<p>Rails 里的许多类重写了这个方法。</p><p>例如<code>nil</code>、<code>true</code>和<code>false</code>会返回其自身。<code>Array#to_param</code>会对数组元素调用<code>to_param</code>并把结果用"/"连接成字符串：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
[0, true, String].to_param # =&gt; "0/true/String"

</pre>
</div>
<p>需要注意的是， Rails 的路由系统会在模型上调用<code>to_param</code>并把结果作为<code>:id</code>占位符。<code>ActiveRecord::Base#to_param</code>会返回模型的<code>id</code>，但是你也可以在自己模型里重新定义它。例如：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class User
  def to_param
    "#{id}-#{name.parameterize}"
  end
end

</pre>
</div>
<p>会得到：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
user_path(@user) # =&gt; "/users/357-john-smith"

</pre>
</div>
<div class="warning"><p>控制器里需要注意被重定义过的<code>to_param</code>，因为一个类似上述的请求里，会把"357-john-smith"当作<code>params[:id]</code>的值。</p></div><div class="note"><p>定义于 <code>active_support/core_ext/object/to_param.rb</code>.</p></div><h4 id="to_query">2.9 <code>to_query</code>
</h4><p>除了散列表之外，给定一个未转义的<code>key</code>，这个方法就会基于这个键和<code>to_param</code>的返回值，构造出一个新的查询字符串。例如：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class User
  def to_param
    "#{id}-#{name.parameterize}"
  end
end

</pre>
</div>
<p>会得到：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
current_user.to_query('user') # =&gt; "user=357-john-smith"

</pre>
</div>
<p>无论对于键还是值，本方法都会根据需要进行转义：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
account.to_query('company[name]')
# =&gt; "company%5Bname%5D=Johnson+%26+Johnson"

</pre>
</div>
<p>所以它的输出已经完全适合于用作查询字符串。</p><p>对于数组，会对其中每个元素以<code>_key_[]</code>为键执行<code>to_query</code>方法，并把结果用"&amp;"连接为字符串：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
[3.4, -45.6].to_query('sample')
# =&gt; "sample%5B%5D=3.4&amp;sample%5B%5D=-45.6"

</pre>
</div>
<p>哈系表也可以响应<code>to_query</code>方法但是用法有所不同。如果调用时没传参数，会先生成一系列排过序的键值对并在值上调用<code>to_query(键)</code>。然后把所得结果用"&amp;"连接为字符串：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
{c: 3, b: 2, a: 1}.to_query # =&gt; "a=1&amp;b=2&amp;c=3"

</pre>
</div>
<p><code>Hash#to_query</code>方法也可接受一个可选的命名空间作为键：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
{id: 89, name: "John Smith"}.to_query('user')
# =&gt; "user%5Bid%5D=89&amp;user%5Bname%5D=John+Smith"

</pre>
</div>
<div class="note"><p>定义于 <code>active_support/core_ext/object/to_query.rb</code>.</p></div><h4 id="with_options">2.10 <code>with_options</code>
</h4><p><code>with_options</code>方法可以为一组方法调用提取出共有的选项。</p><p>假定有一个默认的散列表选项，<code>with_options</code>方法会引入一个代理对象到代码块。在代码块内部，代理对象上的方法调用，会连同被混入的选项一起，被转发至原方法接收者。例如，若要去除下述代码的重复内容：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class Account &lt; ActiveRecord::Base
  has_many :customers, dependent: :destroy
  has_many :products,  dependent: :destroy
  has_many :invoices,  dependent: :destroy
  has_many :expenses,  dependent: :destroy
end

</pre>
</div>
<p>可按此法书写：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class Account &lt; ActiveRecord::Base
  with_options dependent: :destroy do |assoc|
    assoc.has_many :customers
    assoc.has_many :products
    assoc.has_many :invoices
    assoc.has_many :expenses
  end
end

</pre>
</div>
<h2>TODO: clear this after totally understanding what these statnances means...</h2><p>That idiom may convey <em>grouping</em> to the reader as well. For example, say you want to send a newsletter whose language depends on the user. Somewhere in the mailer you could group locale-dependent bits like this:
上述写法也可用于对读取器进行分组。例如，假设你要发一份新闻通讯，通讯所用语言取决于用户。便可以利用如下例所示代码，对用户按照地区依赖进行分组：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
I18n.with_options locale: user.locale, scope: "newsletter" do |i18n|
  subject i18n.t :subject
  body    i18n.t :body, user_name: user.name
end

</pre>
</div>
<div class="info"><p>由于<code>with_options</code>会把方法调用转发给其自身的接收者，所以可以进行嵌套。每层嵌套都会把继承来的默认值混入到自身的默认值里。</p></div><div class="note"><p>定义于 <code>active_support/core_ext/object/with_options.rb</code>.</p></div><h4 id="json-支持">2.11 JSON 支持</h4><p>相较于 <code>json</code> gem 为 Ruby 对象提供的<code>to_json</code>方法，Active Support 给出了一个更好的实现。因为有许多类，诸如<code>Hash</code>、<code>OrderedHash</code>和<code>Process::Status</code>，都需要做特殊处理才能到适合的 JSON 替换。</p><div class="note"><p>定义于 <code>active_support/core_ext/object/json.rb</code>.</p></div><h4 id="实例变量">2.12 实例变量</h4><p>Active Support 提供了若干方法以简化对实例变量的访问。</p><h5 id="instance_values">2.12.1 <code>instance_values</code>
</h5><p><code>instance_values</code>方法返回一个散列表，其中会把实例变量名去掉"@"作为键，把相应的实例变量值作为值。键全部是字符串：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class C
  def initialize(x, y)
    @x, @y = x, y
  end
end

C.new(0, 1).instance_values # =&gt; {"x" =&gt; 0, "y" =&gt; 1}

</pre>
</div>
<div class="note"><p>定义于 <code>active_support/core_ext/object/instance_variables.rb</code>.</p></div><h5 id="instance_variable_names">2.12.2 <code>instance_variable_names</code>
</h5><p><code>instance_variable_names</code>方法返回一个数组。数组中所有的实例变量名都带有"@"标志。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class C
  def initialize(x, y)
    @x, @y = x, y
  end
end

C.new(0, 1).instance_variable_names # =&gt; ["@x", "@y"]

</pre>
</div>
<div class="note"><p>定义于 <code>active_support/core_ext/object/instance_variables.rb</code>.</p></div><h4 id="silencing-warnings,-streams,-和-exceptions">2.13 Silencing Warnings, Streams, 和 Exceptions</h4><p><code>silence_warnings</code>和<code>enable_warnings</code>方法都可以在其代码块里改变<code>$VERBOSE</code>的值，并在之后把值重置：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
silence_warnings { Object.const_set "RAILS_DEFAULT_LOGGER", logger }

</pre>
</div>
<p>You can silence any stream while a block runs with <code>silence_stream</code>:
在通过<code>silence_stream</code>执行的代码块里，可以使任意流安静的运行：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
silence_stream(STDOUT) do
  # 这里的代码不会输出到 STDOUT
end

</pre>
</div>
<p><code>quietly</code>方法可以使 STDOUT 和 STDERR 保持安静，即便在子进程里也如此：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
quietly { system 'bundle install' }

</pre>
</div>
<p>例如，railties 测试组件会用到上述方法，来阻止普通消息与进度状态混到一起。</p><p>也可以用<code>suppress</code>方法来使异常保持安静。方法接收任意数量的异常类。如果代码块的代码执行时报出异常，并且该异常<code>kind_of?</code>满足任一参数，<code>suppress</code>便会将异其捕获并安静的返回。否则会重新抛出该异常：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# If the user is locked the increment is lost, no big deal.
suppress(ActiveRecord::StaleObjectError) do
  current_user.increment! :visits
end

</pre>
</div>
<div class="note"><p>定义于 <code>active_support/core_ext/kernel/reporting.rb</code>.</p></div><h4 id="in-questionmark">2.14 <code>in?</code>
</h4><p>判断式<code>in?</code>用于测试一个对象是否被包含在另一个对象里。当传入的参数无法响应<code>include?</code>时，会抛出<code>ArgumentError</code>异常。</p><p>使用<code>in?</code>的例子：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
1.in?([1,2])        # =&gt; true
"lo".in?("hello")   # =&gt; true
25.in?(30..50)      # =&gt; false
1.in?(1)            # =&gt; ArgumentError

</pre>
</div>
<div class="note"><p>定义于 <code>active_support/core_ext/object/inclusion.rb</code>.</p></div><h3 id="对module的扩展">3 对<code>Module</code>的扩展</h3><h4 id="alias_method_chain">3.1 <code>alias_method_chain</code>
</h4><p>使用纯 Ruby 可以用方法环绕其他的方法，这种做法被称为环绕别名。</p><p>例如，我们假设在功能测试里你希望参数都是字符串，就如同真实的请求中那样，但是同时你也希望对于数字和其他类型的值能够很方便的赋值。为了做到这点，你可以把<code>test/test_helper.rb</code>里的<code>ActionController::TestCase#process</code>方法像下面这样环绕：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
ActionController::TestCase.class_eval do
  # save a reference to the original process method
  alias_method :original_process, :process

  # now redefine process and delegate to original_process
  def process(action, params=nil, session=nil, flash=nil, http_method='GET')
    params = Hash[*params.map {|k, v| [k, v.to_s]}.flatten]
    original_process(action, params, session, flash, http_method)
  end
end

</pre>
</div>
<p><code>get</code>、<code>post</code>等最终会通过此方法执行。</p><p>这么做有一定风险，<code>:original_process</code>有可能已经被占用了。为了避免方法名发生碰撞，通常会添加标签来表明这是个关于什么的别名：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
ActionController::TestCase.class_eval do
  def process_with_stringified_params(...)
    params = Hash[*params.map {|k, v| [k, v.to_s]}.flatten]
    process_without_stringified_params(action, params, session, flash, http_method)
  end
  alias_method :process_without_stringified_params, :process
  alias_method :process, :process_with_stringified_params
end

</pre>
</div>
<p><code>alias_method_chain</code>为上述技巧提供了一个便捷之法：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
ActionController::TestCase.class_eval do
  def process_with_stringified_params(...)
    params = Hash[*params.map {|k, v| [k, v.to_s]}.flatten]
    process_without_stringified_params(action, params, session, flash, http_method)
  end
  alias_method_chain :process, :stringified_params
end

</pre>
</div>
<p>Rails 源代码中随处可见<code>alias_method_chain</code>。例如<code>ActiveRecord::Base#save</code>里，就通过这种方式对方法进行环绕，从 validations 下一个专门的模块里为其增加了验证。</p><div class="note"><p>定义于 <code>active_support/core_ext/module/aliasing.rb</code>.</p></div><h4 id="属性">3.2 属性</h4><h5 id="alias_attribute">3.2.1 <code>alias_attribute</code>
</h5><p>模型属性包含读取器、写入器和判断式。只需添加一行代码，就可以为模型属性添加一个包含以上三个方法的别名。与其他别名方法一样，新名称充当第一个参数，原有名称是第二个参数（为了方便记忆，可以类比下赋值时的书写顺序）。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class User &lt; ActiveRecord::Base
  # You can refer to the email column as "login".
  # This can be meaningful for authentication code.
  alias_attribute :login, :email
end

</pre>
</div>
<div class="note"><p>定义于 <code>active_support/core_ext/module/aliasing.rb</code>.</p></div><h5 id="内部属性">3.2.2 内部属性</h5><p>当你在一个被继承的类里定义一条属性时，属性名称有可能会发生碰撞。这一点对许多库而言尤为重要。</p><p>Active Support 定义了<code>attr_internal_reader</code>、<code>attr_internal_writer</code>和<code>attr_internal_accessor</code>这些类宏。它们的作用与 Ruby 内建的<code>attr_*</code>相当，只不过实例变量名多了下划线以避免碰撞。</p><p>类宏<code>attr_internal</code>与<code>attr_internal_accessor</code>是同义：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# library
class ThirdPartyLibrary::Crawler
  attr_internal :log_level
end

# client code
class MyCrawler &lt; ThirdPartyLibrary::Crawler
  attr_accessor :log_level
end

</pre>
</div>
<p>上述例子里的情况可能是，<code>:log_level</code>并不属于库的公共接口，而是只用于开发。而在客户代码里，由于不知道可能出现的冲突，便在子类里又定义了<code>:log_level</code>。多亏了<code>attr_internal</code>才没有出项碰撞。</p><p>默认情况下，内部实例变量名以下划线开头，如上例中即为<code>@_log_level</code>。不过这点可以通过<code>Module.attr_internal_naming_format</code>进行配置，你可以传入任何<code>sprintf</code>这一类的格式化字符串，并在开头加上<code>@</code>，同时还要加上<code>%s</code>表示变量名称的位置。默认值为<code>"@_%s"</code>。</p><p>Rails 在若干地方使用了内部属性，比如在视图层：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
module ActionView
  class Base
    attr_internal :captures
    attr_internal :request, :layout
    attr_internal :controller, :template
  end
end

</pre>
</div>
<div class="note"><p>定义于 <code>active_support/core_ext/module/attr_internal.rb</code>.</p></div><h5 id="module-attributes">3.2.3 Module Attributes</h5><p>类宏<code>mattr_reader</code>、<code>mattr_writer</code>和<code>mattr_accessor</code>与为类定义的<code>cattr_*</code>是相同的。实际上，<code>cattr_*</code>系列的类宏只不过是<code>mattr_*</code>这些类宏的别名。详见<a href="#class-attributes">Class Attributes</a>。</p><p>例如，依赖性机制就用到了它们：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
module ActiveSupport
  module Dependencies
    mattr_accessor :warnings_on_first_load
    mattr_accessor :history
    mattr_accessor :loaded
    mattr_accessor :mechanism
    mattr_accessor :load_paths
    mattr_accessor :load_once_paths
    mattr_accessor :autoloaded_constants
    mattr_accessor :explicitly_unloadable_constants
    mattr_accessor :logger
    mattr_accessor :log_activity
    mattr_accessor :constant_watch_stack
    mattr_accessor :constant_watch_stack_mutex
  end
end

</pre>
</div>
<div class="note"><p>定义于 <code>active_support/core_ext/module/attribute_accessors.rb</code>.</p></div><h4 id="对module的扩展-parents">3.3 Parents</h4><h5 id="parent">3.3.1 <code>parent</code>
</h5><p>对一个嵌套的模块调用<code>parent</code>方法，会返回其相应的常量：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
module X
  module Y
    module Z
    end
  end
end
M = X::Y::Z

X::Y::Z.parent # =&gt; X::Y
M.parent       # =&gt; X::Y

</pre>
</div>
<p>如果这个模块是匿名的或者属于顶级作用域， <code>parent</code>会返回<code>Object</code>。</p><div class="warning"><p>若有上述情况，则<code>parent_name</code>会返回<code>nil</code>。</p></div><div class="note"><p>定义于 <code>active_support/core_ext/module/introspection.rb</code>.</p></div><h5 id="parent_name">3.3.2 <code>parent_name</code>
</h5><p>对一个嵌套的模块调用<code>parent_name</code>方法，会返回其相应常量的完全限定名：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
module X
  module Y
    module Z
    end
  end
end
M = X::Y::Z

X::Y::Z.parent_name # =&gt; "X::Y"
M.parent_name       # =&gt; "X::Y"

</pre>
</div>
<p>定义在顶级作用域里的模块或匿名的模块，<code>parent_name</code>会返回<code>nil</code>。</p><div class="warning"><p>若有上述情况，则<code>parent</code>返回<code>Object</code>。</p></div><div class="note"><p>定义于 <code>active_support/core_ext/module/introspection.rb</code>.</p></div><h5 id="对module的扩展-parents-parents">3.3.3 <code>parents</code>
</h5><p><code>parents</code>方法会对接收者调用<code>parent</code>，并向上追溯直至<code>Object</code>。之后所得结果链按由低到高顺序组成一个数组被返回。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
module X
  module Y
    module Z
    end
  end
end
M = X::Y::Z

X::Y::Z.parents # =&gt; [X::Y, X, Object]
M.parents       # =&gt; [X::Y, X, Object]

</pre>
</div>
<div class="note"><p>定义于 <code>active_support/core_ext/module/introspection.rb</code>.</p></div><h4 id="常量">3.4 常量</h4><p>defined in the receiver module:
<code>local_constants</code>方法返回在接收者模块中定义的常量。</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
module X
  X1 = 1
  X2 = 2
  module Y
    Y1 = :y1
    X1 = :overrides_X1_above
  end
end

X.local_constants    # =&gt; [:X1, :X2, :Y]
X::Y.local_constants # =&gt; [:Y1, :X1]

</pre>
</div>
<p>常量名会作为符号被返回。</p><div class="note"><p>定义于 <code>active_support/core_ext/module/introspection.rb</code>.</p></div><h5 id="限定常量名">3.4.1 限定常量名</h5><p>标准方法<code>const_defined?</code>、<code>const_get</code>和<code>const_set</code>接受裸常量名。
Active Support 扩展了这些API使其可以接受相对限定常量名。</p><p>新的方法名是<code>qualified_const_defined?</code>，<code>qualified_const_get</code>和<code>qualified_const_set</code>。
它们的参数被假定为相对于其接收者的限定常量名：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
Object.qualified_const_defined?("Math::PI")       # =&gt; true
Object.qualified_const_get("Math::PI")            # =&gt; 3.141592653589793
Object.qualified_const_set("Math::Phi", 1.618034) # =&gt; 1.618034

</pre>
</div>
<p>参数可以使用裸常量名：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
Math.qualified_const_get("E") # =&gt; 2.718281828459045

</pre>
</div>
<p>These methods are analogous to their built-in counterparts. In particular,
<code>qualified_constant_defined?</code> accepts an optional second argument to be
able to say whether you want the predicate to look in the ancestors.
This flag is taken into account for each constant in the expression while
walking down the path.
这些方法与其内建的对应方法很类似。尤为值得一提的是，<code>qualified_constant_defined?</code>接收一个可选的第二参数，以此来标明你是否要在祖先链中进行查找。</p><p>例如，假定：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
module M
  X = 1
end

module N
  class C
    include M
  end
end

</pre>
</div>
<p><code>qualified_const_defined?</code>会这样执行：</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
N.qualified_const_defined?("C::X", false) # =&gt; false
N.qualified_const_defined?("C::X", true)  # =&gt; true
N.qualified_const_defined?("C::X")        # =&gt; true

</pre>
</div>
<p>As the last example implies, the second argument defaults to true,
as in <code>const_defined?</code>.</p><p>For coherence with the built-in methods only relative paths are accepted.
Absolute qualified constant names like <code>::Math::PI</code> raise <code>NameError</code>.</p><div class="note"><p>定义于 <code>active_support/core_ext/module/qualified_const.rb</code>.</p></div><h4 id="reachable">3.5 Reachable</h4><p>A named module is reachable if it is stored in its corresponding constant. It means you can reach the module object via the constant.</p><p>That is what ordinarily happens, if a module is called "M", the <code>M</code> constant exists and holds it:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
module M
end

M.reachable? # =&gt; true

</pre>
</div>
<p>But since constants and modules are indeed kind of decoupled, module objects can become unreachable:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
module M
end

orphan = Object.send(:remove_const, :M)

# The module object is orphan now but it still has a name.
orphan.name # =&gt; "M"

# You cannot reach it via the constant M because it does not even exist.
orphan.reachable? # =&gt; false

# Let's define a module called "M" again.
module M
end

# The constant M exists now again, and it stores a module
# object called "M", but it is a new instance.
orphan.reachable? # =&gt; false

</pre>
</div>
<div class="note"><p>定义于 <code>active_support/core_ext/module/reachable.rb</code>.</p></div><h4 id="anonymous">3.6 Anonymous</h4><p>A module may or may not have a name:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
module M
end
M.name # =&gt; "M"

N = Module.new
N.name # =&gt; "N"

Module.new.name # =&gt; nil

</pre>
</div>
<p>You can check whether a module has a name with the predicate <code>anonymous?</code>:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
module M
end
M.anonymous? # =&gt; false

Module.new.anonymous? # =&gt; true

</pre>
</div>
<p>Note that being unreachable does not imply being anonymous:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
module M
end

m = Object.send(:remove_const, :M)

m.reachable? # =&gt; false
m.anonymous? # =&gt; false

</pre>
</div>
<p>though an anonymous module is unreachable by definition.</p><div class="note"><p>定义于 <code>active_support/core_ext/module/anonymous.rb</code>.</p></div><h4 id="method-delegation">3.7 Method Delegation</h4><p>The macro <code>delegate</code> offers an easy way to forward methods.</p><p>Let's imagine that users in some application have login information in the <code>User</code> model but name and other data in a separate <code>Profile</code> model:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class User &lt; ActiveRecord::Base
  has_one :profile
end

</pre>
</div>
<p>With that configuration you get a user's name via their profile, <code>user.profile.name</code>, but it could be handy to still be able to access such attribute directly:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class User &lt; ActiveRecord::Base
  has_one :profile

  def name
    profile.name
  end
end

</pre>
</div>
<p>That is what <code>delegate</code> does for you:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class User &lt; ActiveRecord::Base
  has_one :profile

  delegate :name, to: :profile
end

</pre>
</div>
<p>It is shorter, and the intention more obvious.</p><p>The method must be public in the target.</p><p>The <code>delegate</code> macro accepts several methods:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
delegate :name, :age, :address, :twitter, to: :profile

</pre>
</div>
<p>When interpolated into a string, the <code>:to</code> option should become an expression that evaluates to the object the method is delegated to. Typically a string or symbol. Such an expression is evaluated in the context of the receiver:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# delegates to the Rails constant
delegate :logger, to: :Rails

# delegates to the receiver's class
delegate :table_name, to: :class

</pre>
</div>
<div class="warning"><p>If the <code>:prefix</code> option is <code>true</code> this is less generic, see below.</p></div><p>By default, if the delegation raises <code>NoMethodError</code> and the target is <code>nil</code> the exception is propagated. You can ask that <code>nil</code> is returned instead with the <code>:allow_nil</code> option:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
delegate :name, to: :profile, allow_nil: true

</pre>
</div>
<p>With <code>:allow_nil</code> the call <code>user.name</code> returns <code>nil</code> if the user has no profile.</p><p>The option <code>:prefix</code> adds a prefix to the name of the generated method. This may be handy for example to get a better name:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
delegate :street, to: :address, prefix: true

</pre>
</div>
<p>The previous example generates <code>address_street</code> rather than <code>street</code>.</p><div class="warning"><p>Since in this case the name of the generated method is composed of the target object and target method names, the <code>:to</code> option must be a method name.</p></div><p>A custom prefix may also be configured:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
delegate :size, to: :attachment, prefix: :avatar

</pre>
</div>
<p>In the previous example the macro generates <code>avatar_size</code> rather than <code>size</code>.</p><div class="note"><p>定义于 <code>active_support/core_ext/module/delegation.rb</code></p></div><h4 id="redefining-methods">3.8 Redefining Methods</h4><p>There are cases where you need to define a method with <code>define_method</code>, but don't know whether a method with that name already exists. If it does, a warning is issued if they are enabled. No big deal, but not clean either.</p><p>The method <code>redefine_method</code> prevents such a potential warning, removing the existing method before if needed.</p><div class="note"><p>定义于 <code>active_support/core_ext/module/remove_method.rb</code></p></div><h3 id="extensions-to-class">4 Extensions to <code>Class</code>
</h3><h4 id="class-attributes">4.1 Class Attributes</h4><h5 id="class_attribute">4.1.1 <code>class_attribute</code>
</h5><p>The method <code>class_attribute</code> declares one or more inheritable class attributes that can be overridden at any level down the hierarchy.</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class A
  class_attribute :x
end

class B &lt; A; end

class C &lt; B; end

A.x = :a
B.x # =&gt; :a
C.x # =&gt; :a

B.x = :b
A.x # =&gt; :a
C.x # =&gt; :b

C.x = :c
A.x # =&gt; :a
B.x # =&gt; :b

</pre>
</div>
<p>For example <code>ActionMailer::Base</code> defines:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class_attribute :default_params
self.default_params = {
  mime_version: "1.0",
  charset: "UTF-8",
  content_type: "text/plain",
  parts_order: [ "text/plain", "text/enriched", "text/html" ]
}.freeze

</pre>
</div>
<p>They can be also accessed and overridden at the instance level.</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
A.x = 1

a1 = A.new
a2 = A.new
a2.x = 2

a1.x # =&gt; 1, comes from A
a2.x # =&gt; 2, overridden in a2

</pre>
</div>
<p>The generation of the writer instance method can be prevented by setting the option <code>:instance_writer</code> to <code>false</code>.</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
module ActiveRecord
  class Base
    class_attribute :table_name_prefix, instance_writer: false
    self.table_name_prefix = ""
  end
end

</pre>
</div>
<p>A model may find that option useful as a way to prevent mass-assignment from setting the attribute.</p><p>The generation of the reader instance method can be prevented by setting the option <code>:instance_reader</code> to <code>false</code>.</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class A
  class_attribute :x, instance_reader: false
end

A.new.x = 1 # NoMethodError

</pre>
</div>
<p>For convenience <code>class_attribute</code> also defines an instance predicate which is the double negation of what the instance reader returns. In the examples above it would be called <code>x?</code>.</p><p>When <code>:instance_reader</code> is <code>false</code>, the instance predicate returns a <code>NoMethodError</code> just like the reader method.</p><p>If you do not want the instance predicate, pass <code>instance_predicate: false</code> and it will not be defined.</p><div class="note"><p>定义于 <code>active_support/core_ext/class/attribute.rb</code></p></div><h5 id="cattr_reader,-cattr_writer,-and-cattr_accessor">4.1.2 <code>cattr_reader</code>, <code>cattr_writer</code>, and <code>cattr_accessor</code>
</h5><p>The macros <code>cattr_reader</code>, <code>cattr_writer</code>, and <code>cattr_accessor</code> are analogous to their <code>attr_*</code> counterparts but for classes. They initialize a class variable to <code>nil</code> unless it already exists, and generate the corresponding class methods to access it:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class MysqlAdapter &lt; AbstractAdapter
  # Generates class methods to access @@emulate_booleans.
  cattr_accessor :emulate_booleans
  self.emulate_booleans = true
end

</pre>
</div>
<p>Instance methods are created as well for convenience, they are just proxies to the class attribute. So, instances can change the class attribute, but cannot override it as it happens with <code>class_attribute</code> (see above). For example given</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
module ActionView
  class Base
    cattr_accessor :field_error_proc
    @@field_error_proc = Proc.new{ ... }
  end
end

</pre>
</div>
<p>we can access <code>field_error_proc</code> in views.</p><p>Also, you can pass a block to <code>cattr_*</code> to set up the attribute with a default value:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class MysqlAdapter &lt; AbstractAdapter
  # Generates class methods to access @@emulate_booleans with default value of true.
  cattr_accessor(:emulate_booleans) { true }
end

</pre>
</div>
<p>The generation of the reader instance method can be prevented by setting <code>:instance_reader</code> to <code>false</code> and the generation of the writer instance method can be prevented by setting <code>:instance_writer</code> to <code>false</code>. Generation of both methods can be prevented by setting <code>:instance_accessor</code> to <code>false</code>. In all cases, the value must be exactly <code>false</code> and not any false value.</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
module A
  class B
    # No first_name instance reader is generated.
    cattr_accessor :first_name, instance_reader: false
    # No last_name= instance writer is generated.
    cattr_accessor :last_name, instance_writer: false
    # No surname instance reader or surname= writer is generated.
    cattr_accessor :surname, instance_accessor: false
  end
end

</pre>
</div>
<p>A model may find it useful to set <code>:instance_accessor</code> to <code>false</code> as a way to prevent mass-assignment from setting the attribute.</p><div class="note"><p>定义于 <code>active_support/core_ext/module/attribute_accessors.rb</code>.</p></div><h4 id="subclasses-&amp;-descendants">4.2 Subclasses &amp; Descendants</h4><h5 id="subclasses">4.2.1 <code>subclasses</code>
</h5><p>The <code>subclasses</code> method returns the subclasses of the receiver:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class C; end
C.subclasses # =&gt; []

class B &lt; C; end
C.subclasses # =&gt; [B]

class A &lt; B; end
C.subclasses # =&gt; [B]

class D &lt; C; end
C.subclasses # =&gt; [B, D]

</pre>
</div>
<p>The order in which these classes are returned is unspecified.</p><div class="note"><p>定义于 <code>active_support/core_ext/class/subclasses.rb</code>.</p></div><h5 id="descendants">4.2.2 <code>descendants</code>
</h5><p>The <code>descendants</code> method returns all classes that are <code>&lt;</code> than its receiver:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class C; end
C.descendants # =&gt; []

class B &lt; C; end
C.descendants # =&gt; [B]

class A &lt; B; end
C.descendants # =&gt; [B, A]

class D &lt; C; end
C.descendants # =&gt; [B, A, D]

</pre>
</div>
<p>The order in which these classes are returned is unspecified.</p><div class="note"><p>定义于 <code>active_support/core_ext/class/subclasses.rb</code>.</p></div><h3 id="extensions-to-string">5 Extensions to <code>String</code>
</h3><h4 id="output-safety">5.1 Output Safety</h4><h5 id="motivation">5.1.1 Motivation</h5><p>Inserting data into HTML templates needs extra care. For example, you can't just interpolate <code>@review.title</code> verbatim into an HTML page. For one thing, if the review title is "Flanagan &amp; Matz rules!" the output won't be well-formed because an ampersand has to be escaped as "&amp;amp;". What's more, depending on the application, that may be a big security hole because users can inject malicious HTML setting a hand-crafted review title. Check out the section about cross-site scripting in the <a href="security.html#cross-site-scripting-xss">Security guide</a> for further information about the risks.</p><h5 id="safe-strings">5.1.2 Safe Strings</h5><p>Active Support has the concept of <em>(html) safe</em> strings. A safe string is one that is marked as being insertable into HTML as is. It is trusted, no matter whether it has been escaped or not.</p><p>Strings are considered to be <em>unsafe</em> by default:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"".html_safe? # =&gt; false

</pre>
</div>
<p>You can obtain a safe string from a given one with the <code>html_safe</code> method:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
s = "".html_safe
s.html_safe? # =&gt; true

</pre>
</div>
<p>It is important to understand that <code>html_safe</code> performs no escaping whatsoever, it is just an assertion:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
s = "&lt;script&gt;...&lt;/script&gt;".html_safe
s.html_safe? # =&gt; true
s            # =&gt; "&lt;script&gt;...&lt;/script&gt;"

</pre>
</div>
<p>It is your responsibility to ensure calling <code>html_safe</code> on a particular string is fine.</p><p>If you append onto a safe string, either in-place with <code>concat</code>/<code>&lt;&lt;</code>, or with <code>+</code>, the result is a safe string. Unsafe arguments are escaped:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"".html_safe + "&lt;" # =&gt; "&amp;lt;"

</pre>
</div>
<p>Safe arguments are directly appended:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"".html_safe + "&lt;".html_safe # =&gt; "&lt;"

</pre>
</div>
<p>These methods should not be used in ordinary views. Unsafe values are automatically escaped:</p><div class="code_container">
<pre class="brush: ruby; html-script: true; gutter: false; toolbar: false">
&lt;%= @review.title %&gt; &lt;%# fine, escaped if needed %&gt;

</pre>
</div>
<p>To insert something verbatim use the <code>raw</code> helper rather than calling <code>html_safe</code>:</p><div class="code_container">
<pre class="brush: ruby; html-script: true; gutter: false; toolbar: false">
&lt;%= raw @cms.current_template %&gt; &lt;%# inserts @cms.current_template as is %&gt;

</pre>
</div>
<p>or, equivalently, use <code>&lt;%==</code>:</p><div class="code_container">
<pre class="brush: ruby; html-script: true; gutter: false; toolbar: false">
&lt;%== @cms.current_template %&gt; &lt;%# inserts @cms.current_template as is %&gt;

</pre>
</div>
<p>The <code>raw</code> helper calls <code>html_safe</code> for you:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
def raw(stringish)
  stringish.to_s.html_safe
end

</pre>
</div>
<div class="note"><p>定义于 <code>active_support/core_ext/string/output_safety.rb</code>.</p></div><h5 id="transformation">5.1.3 Transformation</h5><p>As a rule of thumb, except perhaps for concatenation as explained above, any method that may change a string gives you an unsafe string. These are <code>downcase</code>, <code>gsub</code>, <code>strip</code>, <code>chomp</code>, <code>underscore</code>, etc.</p><p>In the case of in-place transformations like <code>gsub!</code> the receiver itself becomes unsafe.</p><div class="info"><p>The safety bit is lost always, no matter whether the transformation actually changed something.</p></div><h5 id="conversion-and-coercion">5.1.4 Conversion and Coercion</h5><p>Calling <code>to_s</code> on a safe string returns a safe string, but coercion with <code>to_str</code> returns an unsafe string.</p><h5 id="copying">5.1.5 Copying</h5><p>Calling <code>dup</code> or <code>clone</code> on safe strings yields safe strings.</p><h4 id="remove">5.2 <code>remove</code>
</h4><p>The method <code>remove</code> will remove all occurrences of the pattern:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"Hello World".remove(/Hello /) =&gt; "World"

</pre>
</div>
<p>There's also the destructive version <code>String#remove!</code>.</p><div class="note"><p>定义于 <code>active_support/core_ext/string/filters.rb</code>.</p></div><h4 id="squish">5.3 <code>squish</code>
</h4><p>The method <code>squish</code> strips leading and trailing whitespace, and substitutes runs of whitespace with a single space each:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
" \n  foo\n\r \t bar \n".squish # =&gt; "foo bar"

</pre>
</div>
<p>There's also the destructive version <code>String#squish!</code>.</p><p>Note that it handles both ASCII and Unicode whitespace like mongolian vowel separator (U+180E).</p><div class="note"><p>定义于 <code>active_support/core_ext/string/filters.rb</code>.</p></div><h4 id="truncate">5.4 <code>truncate</code>
</h4><p>The method <code>truncate</code> returns a copy of its receiver truncated after a given <code>length</code>:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"Oh dear! Oh dear! I shall be late!".truncate(20)
# =&gt; "Oh dear! Oh dear!..."

</pre>
</div>
<p>Ellipsis can be customized with the <code>:omission</code> option:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"Oh dear! Oh dear! I shall be late!".truncate(20, omission: '&amp;hellip;')
# =&gt; "Oh dear! Oh &amp;hellip;"

</pre>
</div>
<p>Note in particular that truncation takes into account the length of the omission string.</p><p>Pass a <code>:separator</code> to truncate the string at a natural break:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"Oh dear! Oh dear! I shall be late!".truncate(18)
# =&gt; "Oh dear! Oh dea..."
"Oh dear! Oh dear! I shall be late!".truncate(18, separator: ' ')
# =&gt; "Oh dear! Oh..."

</pre>
</div>
<p>The option <code>:separator</code> can be a regexp:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"Oh dear! Oh dear! I shall be late!".truncate(18, separator: /\s/)
# =&gt; "Oh dear! Oh..."

</pre>
</div>
<p>In above examples "dear" gets cut first, but then <code>:separator</code> prevents it.</p><div class="note"><p>定义于 <code>active_support/core_ext/string/filters.rb</code>.</p></div><h4 id="inquiry">5.5 <code>inquiry</code>
</h4><p>The <code>inquiry</code> method converts a string into a <code>StringInquirer</code> object making equality checks prettier.</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"production".inquiry.production? # =&gt; true
"active".inquiry.inactive?       # =&gt; false

</pre>
</div>
<h4 id="starts_with-questionmark-and-ends_with-questionmark">5.6 <code>starts_with?</code> and <code>ends_with?</code>
</h4><p>Active Support defines 3rd person aliases of <code>String#start_with?</code> and <code>String#end_with?</code>:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"foo".starts_with?("f") # =&gt; true
"foo".ends_with?("o")   # =&gt; true

</pre>
</div>
<div class="note"><p>定义于 <code>active_support/core_ext/string/starts_ends_with.rb</code>.</p></div><h4 id="strip_heredoc">5.7 <code>strip_heredoc</code>
</h4><p>The method <code>strip_heredoc</code> strips indentation in heredocs.</p><p>For example in</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
if options[:usage]
  puts &lt;&lt;-USAGE.strip_heredoc
    This command does such and such.

    Supported options are:
      -h         This message
      ...
  USAGE
end

</pre>
</div>
<p>the user would see the usage message aligned against the left margin.</p><p>Technically, it looks for the least indented line in the whole string, and removes
that amount of leading whitespace.</p><div class="note"><p>定义于 <code>active_support/core_ext/string/strip.rb</code>.</p></div><h4 id="indent">5.8 <code>indent</code>
</h4><p>Indents the lines in the receiver:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
&lt;&lt;EOS.indent(2)
def some_method
  some_code
end
EOS
# =&gt;
  def some_method
    some_code
  end

</pre>
</div>
<p>The second argument, <code>indent_string</code>, specifies which indent string to use. The default is <code>nil</code>, which tells the method to make an educated guess peeking at the first indented line, and fallback to a space if there is none.</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"  foo".indent(2)        # =&gt; "    foo"
"foo\n\t\tbar".indent(2) # =&gt; "\t\tfoo\n\t\t\t\tbar"
"foo".indent(2, "\t")    # =&gt; "\t\tfoo"

</pre>
</div>
<p>While <code>indent_string</code> is typically one space or tab, it may be any string.</p><p>The third argument, <code>indent_empty_lines</code>, is a flag that says whether empty lines should be indented. Default is false.</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"foo\n\nbar".indent(2)            # =&gt; "  foo\n\n  bar"
"foo\n\nbar".indent(2, nil, true) # =&gt; "  foo\n  \n  bar"

</pre>
</div>
<p>The <code>indent!</code> method performs indentation in-place.</p><div class="note"><p>定义于 <code>active_support/core_ext/string/indent.rb</code>.</p></div><h4 id="access">5.9 Access</h4><h5 id="at(position)">5.9.1 <code>at(position)</code>
</h5><p>Returns the character of the string at position <code>position</code>:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"hello".at(0)  # =&gt; "h"
"hello".at(4)  # =&gt; "o"
"hello".at(-1) # =&gt; "o"
"hello".at(10) # =&gt; nil

</pre>
</div>
<div class="note"><p>定义于 <code>active_support/core_ext/string/access.rb</code>.</p></div><h5 id="from(position)">5.9.2 <code>from(position)</code>
</h5><p>Returns the substring of the string starting at position <code>position</code>:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"hello".from(0)  # =&gt; "hello"
"hello".from(2)  # =&gt; "llo"
"hello".from(-2) # =&gt; "lo"
"hello".from(10) # =&gt; "" if &lt; 1.9, nil in 1.9

</pre>
</div>
<div class="note"><p>定义于 <code>active_support/core_ext/string/access.rb</code>.</p></div><h5 id="to(position)">5.9.3 <code>to(position)</code>
</h5><p>Returns the substring of the string up to position <code>position</code>:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"hello".to(0)  # =&gt; "h"
"hello".to(2)  # =&gt; "hel"
"hello".to(-2) # =&gt; "hell"
"hello".to(10) # =&gt; "hello"

</pre>
</div>
<div class="note"><p>定义于 <code>active_support/core_ext/string/access.rb</code>.</p></div><h5 id="first(limit-=-1)">5.9.4 <code>first(limit = 1)</code>
</h5><p>The call <code>str.first(n)</code> is equivalent to <code>str.to(n-1)</code> if <code>n</code> &gt; 0, and returns an empty string for <code>n</code> == 0.</p><div class="note"><p>定义于 <code>active_support/core_ext/string/access.rb</code>.</p></div><h5 id="last(limit-=-1)">5.9.5 <code>last(limit = 1)</code>
</h5><p>The call <code>str.last(n)</code> is equivalent to <code>str.from(-n)</code> if <code>n</code> &gt; 0, and returns an empty string for <code>n</code> == 0.</p><div class="note"><p>定义于 <code>active_support/core_ext/string/access.rb</code>.</p></div><h4 id="inflections">5.10 Inflections</h4><h5 id="pluralize">5.10.1 <code>pluralize</code>
</h5><p>The method <code>pluralize</code> returns the plural of its receiver:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"table".pluralize     # =&gt; "tables"
"ruby".pluralize      # =&gt; "rubies"
"equipment".pluralize # =&gt; "equipment"

</pre>
</div>
<p>As the previous example shows, Active Support knows some irregular plurals and uncountable nouns. Built-in rules can be extended in <code>config/initializers/inflections.rb</code>. That file is generated by the <code>rails</code> command and has instructions in comments.</p><p><code>pluralize</code> can also take an optional <code>count</code> parameter. If <code>count == 1</code> the singular form will be returned. For any other value of <code>count</code> the plural form will be returned:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"dude".pluralize(0) # =&gt; "dudes"
"dude".pluralize(1) # =&gt; "dude"
"dude".pluralize(2) # =&gt; "dudes"

</pre>
</div>
<p>Active Record uses this method to compute the default table name that corresponds to a model:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# active_record/model_schema.rb
def undecorated_table_name(class_name = base_class.name)
  table_name = class_name.to_s.demodulize.underscore
  pluralize_table_names ? table_name.pluralize : table_name
end

</pre>
</div>
<div class="note"><p>定义于 <code>active_support/core_ext/string/inflections.rb</code>.</p></div><h5 id="singularize">5.10.2 <code>singularize</code>
</h5><p>The inverse of <code>pluralize</code>:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"tables".singularize    # =&gt; "table"
"rubies".singularize    # =&gt; "ruby"
"equipment".singularize # =&gt; "equipment"

</pre>
</div>
<p>Associations compute the name of the corresponding default associated class using this method:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# active_record/reflection.rb
def derive_class_name
  class_name = name.to_s.camelize
  class_name = class_name.singularize if collection?
  class_name
end

</pre>
</div>
<div class="note"><p>定义于 <code>active_support/core_ext/string/inflections.rb</code>.</p></div><h5 id="camelize">5.10.3 <code>camelize</code>
</h5><p>The method <code>camelize</code> returns its receiver in camel case:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"product".camelize    # =&gt; "Product"
"admin_user".camelize # =&gt; "AdminUser"

</pre>
</div>
<p>As a rule of thumb you can think of this method as the one that transforms paths into Ruby class or module names, where slashes separate namespaces:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"backoffice/session".camelize # =&gt; "Backoffice::Session"

</pre>
</div>
<p>For example, Action Pack uses this method to load the class that provides a certain session store:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# action_controller/metal/session_management.rb
def session_store=(store)
  @@session_store = store.is_a?(Symbol) ?
    ActionDispatch::Session.const_get(store.to_s.camelize) :
    store
end

</pre>
</div>
<p><code>camelize</code> accepts an optional argument, it can be <code>:upper</code> (default), or <code>:lower</code>. With the latter the first letter becomes lowercase:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"visual_effect".camelize(:lower) # =&gt; "visualEffect"

</pre>
</div>
<p>That may be handy to compute method names in a language that follows that convention, for example JavaScript.</p><div class="info"><p>As a rule of thumb you can think of <code>camelize</code> as the inverse of <code>underscore</code>, though there are cases where that does not hold: <code>"SSLError".underscore.camelize</code> gives back <code>"SslError"</code>. To support cases such as this, Active Support allows you to specify acronyms in <code>config/initializers/inflections.rb</code>:</p></div><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
ActiveSupport::Inflector.inflections do |inflect|
  inflect.acronym 'SSL'
end

"SSLError".underscore.camelize # =&gt; "SSLError"

</pre>
</div>
<p><code>camelize</code> is aliased to <code>camelcase</code>.</p><div class="note"><p>定义于 <code>active_support/core_ext/string/inflections.rb</code>.</p></div><h5 id="underscore">5.10.4 <code>underscore</code>
</h5><p>The method <code>underscore</code> goes the other way around, from camel case to paths:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"Product".underscore   # =&gt; "product"
"AdminUser".underscore # =&gt; "admin_user"

</pre>
</div>
<p>Also converts "::" back to "/":</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"Backoffice::Session".underscore # =&gt; "backoffice/session"

</pre>
</div>
<p>and understands strings that start with lowercase:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"visualEffect".underscore # =&gt; "visual_effect"

</pre>
</div>
<p><code>underscore</code> accepts no argument though.</p><p>Rails class and module autoloading uses <code>underscore</code> to infer the relative path without extension of a file that would define a given missing constant:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# active_support/dependencies.rb
def load_missing_constant(from_mod, const_name)
  ...
  qualified_name = qualified_name_for from_mod, const_name
  path_suffix = qualified_name.underscore
  ...
end

</pre>
</div>
<div class="info"><p>As a rule of thumb you can think of <code>underscore</code> as the inverse of <code>camelize</code>, though there are cases where that does not hold. For example, <code>"SSLError".underscore.camelize</code> gives back <code>"SslError"</code>.</p></div><div class="note"><p>定义于 <code>active_support/core_ext/string/inflections.rb</code>.</p></div><h5 id="titleize">5.10.5 <code>titleize</code>
</h5><p>The method <code>titleize</code> capitalizes the words in the receiver:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"alice in wonderland".titleize # =&gt; "Alice In Wonderland"
"fermat's enigma".titleize     # =&gt; "Fermat's Enigma"

</pre>
</div>
<p><code>titleize</code> is aliased to <code>titlecase</code>.</p><div class="note"><p>定义于 <code>active_support/core_ext/string/inflections.rb</code>.</p></div><h5 id="dasherize">5.10.6 <code>dasherize</code>
</h5><p>The method <code>dasherize</code> replaces the underscores in the receiver with dashes:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"name".dasherize         # =&gt; "name"
"contact_data".dasherize # =&gt; "contact-data"

</pre>
</div>
<p>The XML serializer of models uses this method to dasherize node names:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# active_model/serializers/xml.rb
def reformat_name(name)
  name = name.camelize if camelize?
  dasherize? ? name.dasherize : name
end

</pre>
</div>
<div class="note"><p>定义于 <code>active_support/core_ext/string/inflections.rb</code>.</p></div><h5 id="demodulize">5.10.7 <code>demodulize</code>
</h5><p>Given a string with a qualified constant name, <code>demodulize</code> returns the very constant name, that is, the rightmost part of it:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"Product".demodulize                        # =&gt; "Product"
"Backoffice::UsersController".demodulize    # =&gt; "UsersController"
"Admin::Hotel::ReservationUtils".demodulize # =&gt; "ReservationUtils"
"::Inflections".demodulize                  # =&gt; "Inflections"
"".demodulize                               # =&gt; ""


</pre>
</div>
<p>Active Record for example uses this method to compute the name of a counter cache column:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# active_record/reflection.rb
def counter_cache_column
  if options[:counter_cache] == true
    "#{active_record.name.demodulize.underscore.pluralize}_count"
  elsif options[:counter_cache]
    options[:counter_cache]
  end
end

</pre>
</div>
<div class="note"><p>定义于 <code>active_support/core_ext/string/inflections.rb</code>.</p></div><h5 id="deconstantize">5.10.8 <code>deconstantize</code>
</h5><p>Given a string with a qualified constant reference expression, <code>deconstantize</code> removes the rightmost segment, generally leaving the name of the constant's container:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"Product".deconstantize                        # =&gt; ""
"Backoffice::UsersController".deconstantize    # =&gt; "Backoffice"
"Admin::Hotel::ReservationUtils".deconstantize # =&gt; "Admin::Hotel"

</pre>
</div>
<p>Active Support for example uses this method in <code>Module#qualified_const_set</code>:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
def qualified_const_set(path, value)
  QualifiedConstUtils.raise_if_absolute(path)

  const_name = path.demodulize
  mod_name = path.deconstantize
  mod = mod_name.empty? ? self : qualified_const_get(mod_name)
  mod.const_set(const_name, value)
end

</pre>
</div>
<div class="note"><p>定义于 <code>active_support/core_ext/string/inflections.rb</code>.</p></div><h5 id="parameterize">5.10.9 <code>parameterize</code>
</h5><p>The method <code>parameterize</code> normalizes its receiver in a way that can be used in pretty URLs.</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"John Smith".parameterize # =&gt; "john-smith"
"Kurt Gödel".parameterize # =&gt; "kurt-godel"

</pre>
</div>
<p>In fact, the result string is wrapped in an instance of <code>ActiveSupport::Multibyte::Chars</code>.</p><div class="note"><p>定义于 <code>active_support/core_ext/string/inflections.rb</code>.</p></div><h5 id="tableize">5.10.10 <code>tableize</code>
</h5><p>The method <code>tableize</code> is <code>underscore</code> followed by <code>pluralize</code>.</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"Person".tableize      # =&gt; "people"
"Invoice".tableize     # =&gt; "invoices"
"InvoiceLine".tableize # =&gt; "invoice_lines"

</pre>
</div>
<p>As a rule of thumb, <code>tableize</code> returns the table name that corresponds to a given model for simple cases. The actual implementation in Active Record is not straight <code>tableize</code> indeed, because it also demodulizes the class name and checks a few options that may affect the returned string.</p><div class="note"><p>定义于 <code>active_support/core_ext/string/inflections.rb</code>.</p></div><h5 id="classify">5.10.11 <code>classify</code>
</h5><p>The method <code>classify</code> is the inverse of <code>tableize</code>. It gives you the class name corresponding to a table name:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"people".classify        # =&gt; "Person"
"invoices".classify      # =&gt; "Invoice"
"invoice_lines".classify # =&gt; "InvoiceLine"

</pre>
</div>
<p>The method understands qualified table names:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"highrise_production.companies".classify # =&gt; "Company"

</pre>
</div>
<p>Note that <code>classify</code> returns a class name as a string. You can get the actual class object invoking <code>constantize</code> on it, explained next.</p><div class="note"><p>定义于 <code>active_support/core_ext/string/inflections.rb</code>.</p></div><h5 id="constantize">5.10.12 <code>constantize</code>
</h5><p>The method <code>constantize</code> resolves the constant reference expression in its receiver:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"Fixnum".constantize # =&gt; Fixnum

module M
  X = 1
end
"M::X".constantize # =&gt; 1

</pre>
</div>
<p>If the string evaluates to no known constant, or its content is not even a valid constant name, <code>constantize</code> raises <code>NameError</code>.</p><p>Constant name resolution by <code>constantize</code> starts always at the top-level <code>Object</code> even if there is no leading "::".</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
X = :in_Object
module M
  X = :in_M

  X                 # =&gt; :in_M
  "::X".constantize # =&gt; :in_Object
  "X".constantize   # =&gt; :in_Object (!)
end

</pre>
</div>
<p>So, it is in general not equivalent to what Ruby would do in the same spot, had a real constant be evaluated.</p><p>Mailer test cases obtain the mailer being tested from the name of the test class using <code>constantize</code>:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# action_mailer/test_case.rb
def determine_default_mailer(name)
  name.sub(/Test$/, '').constantize
rescue NameError =&gt; e
  raise NonInferrableMailerError.new(name)
end

</pre>
</div>
<div class="note"><p>定义于 <code>active_support/core_ext/string/inflections.rb</code>.</p></div><h5 id="humanize">5.10.13 <code>humanize</code>
</h5><p>The method <code>humanize</code> tweaks an attribute name for display to end users.</p><p>Specifically performs these transformations:</p>
<ul>
<li>Applies human inflection rules to the argument.</li>
<li>Deletes leading underscores, if any.</li>
<li>Removes a "_id" suffix if present.</li>
<li>Replaces underscores with spaces, if any.</li>
<li>Downcases all words except acronyms.</li>
<li>Capitalizes the first word.</li>
</ul>
<p>The capitalization of the first word can be turned off by setting the
+:capitalize+ option to false (default is true).</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"name".humanize                         # =&gt; "Name"
"author_id".humanize                    # =&gt; "Author"
"author_id".humanize(capitalize: false) # =&gt; "author"
"comments_count".humanize               # =&gt; "Comments count"
"_id".humanize                          # =&gt; "Id"

</pre>
</div>
<p>If "SSL" was defined to be an acronym:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
'ssl_error'.humanize # =&gt; "SSL error"

</pre>
</div>
<p>The helper method <code>full_messages</code> uses <code>humanize</code> as a fallback to include
attribute names:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
def full_messages
  full_messages = []

  each do |attribute, messages|
    ...
    attr_name = attribute.to_s.gsub('.', '_').humanize
    attr_name = @base.class.human_attribute_name(attribute, default: attr_name)
    ...
  end

  full_messages
end

</pre>
</div>
<div class="note"><p>定义于 <code>active_support/core_ext/string/inflections.rb</code>.</p></div><h5 id="foreign_key">5.10.14 <code>foreign_key</code>
</h5><p>The method <code>foreign_key</code> gives a foreign key column name from a class name. To do so it demodulizes, underscores, and adds "_id":</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"User".foreign_key           # =&gt; "user_id"
"InvoiceLine".foreign_key    # =&gt; "invoice_line_id"
"Admin::Session".foreign_key # =&gt; "session_id"

</pre>
</div>
<p>Pass a false argument if you do not want the underscore in "_id":</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"User".foreign_key(false) # =&gt; "userid"

</pre>
</div>
<p>Associations use this method to infer foreign keys, for example <code>has_one</code> and <code>has_many</code> do this:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# active_record/associations.rb
foreign_key = options[:foreign_key] || reflection.active_record.name.foreign_key

</pre>
</div>
<div class="note"><p>定义于 <code>active_support/core_ext/string/inflections.rb</code>.</p></div><h4 id="extensions-to-string-conversions">5.11 Conversions</h4><h5 id="to_date,-to_time,-to_datetime">5.11.1 <code>to_date</code>, <code>to_time</code>, <code>to_datetime</code>
</h5><p>The methods <code>to_date</code>, <code>to_time</code>, and <code>to_datetime</code> are basically convenience wrappers around <code>Date._parse</code>:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"2010-07-27".to_date              # =&gt; Tue, 27 Jul 2010
"2010-07-27 23:37:00".to_time     # =&gt; Tue Jul 27 23:37:00 UTC 2010
"2010-07-27 23:37:00".to_datetime # =&gt; Tue, 27 Jul 2010 23:37:00 +0000

</pre>
</div>
<p><code>to_time</code> receives an optional argument <code>:utc</code> or <code>:local</code>, to indicate which time zone you want the time in:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
"2010-07-27 23:42:00".to_time(:utc)   # =&gt; Tue Jul 27 23:42:00 UTC 2010
"2010-07-27 23:42:00".to_time(:local) # =&gt; Tue Jul 27 23:42:00 +0200 2010

</pre>
</div>
<p>Default is <code>:utc</code>.</p><p>Please refer to the documentation of <code>Date._parse</code> for further details.</p><div class="info"><p>The three of them return <code>nil</code> for blank receivers.</p></div><div class="note"><p>定义于 <code>active_support/core_ext/string/conversions.rb</code>.</p></div><h3 id="extensions-to-numeric">6 Extensions to <code>Numeric</code>
</h3><h4 id="bytes">6.1 Bytes</h4><p>All numbers respond to these methods:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
bytes
kilobytes
megabytes
gigabytes
terabytes
petabytes
exabytes

</pre>
</div>
<p>They return the corresponding amount of bytes, using a conversion factor of 1024:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
2.kilobytes   # =&gt; 2048
3.megabytes   # =&gt; 3145728
3.5.gigabytes # =&gt; 3758096384
-4.exabytes   # =&gt; -4611686018427387904

</pre>
</div>
<p>Singular forms are aliased so you are able to say:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
1.megabyte # =&gt; 1048576

</pre>
</div>
<div class="note"><p>定义于 <code>active_support/core_ext/numeric/bytes.rb</code>.</p></div><h4 id="time">6.2 Time</h4><p>Enables the use of time calculations and declarations, like <code>45.minutes + 2.hours + 4.years</code>.</p><p>These methods use Time#advance for precise date calculations when using from_now, ago, etc.
as well as adding or subtracting their results from a Time object. For example:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# equivalent to Time.current.advance(months: 1)
1.month.from_now

# equivalent to Time.current.advance(years: 2)
2.years.from_now

# equivalent to Time.current.advance(months: 4, years: 5)
(4.months + 5.years).from_now

</pre>
</div>
<p>While these methods provide precise calculation when used as in the examples above, care
should be taken to note that this is not true if the result of <code>months',</code>years', etc is
converted before use:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# equivalent to 30.days.to_i.from_now
1.month.to_i.from_now

# equivalent to 365.25.days.to_f.from_now
1.year.to_f.from_now

</pre>
</div>
<p>In such cases, Ruby's core <a href="http://ruby-doc.org/stdlib/libdoc/date/rdoc/Date.html">Date</a> and
<a href="http://ruby-doc.org/stdlib/libdoc/time/rdoc/Time.html">Time</a> should be used for precision
date and time arithmetic.</p><div class="note"><p>定义于 <code>active_support/core_ext/numeric/time.rb</code>.</p></div><h4 id="formatting">6.3 Formatting</h4><p>Enables the formatting of numbers in a variety of ways.</p><p>Produce a string representation of a number as a telephone number:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
5551234.to_s(:phone)
# =&gt; 555-1234
1235551234.to_s(:phone)
# =&gt; 123-555-1234
1235551234.to_s(:phone, area_code: true)
# =&gt; (123) 555-1234
1235551234.to_s(:phone, delimiter: " ")
# =&gt; 123 555 1234
1235551234.to_s(:phone, area_code: true, extension: 555)
# =&gt; (123) 555-1234 x 555
1235551234.to_s(:phone, country_code: 1)
# =&gt; +1-123-555-1234

</pre>
</div>
<p>Produce a string representation of a number as currency:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
1234567890.50.to_s(:currency)                 # =&gt; $1,234,567,890.50
1234567890.506.to_s(:currency)                # =&gt; $1,234,567,890.51
1234567890.506.to_s(:currency, precision: 3)  # =&gt; $1,234,567,890.506

</pre>
</div>
<p>Produce a string representation of a number as a percentage:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
100.to_s(:percentage)
# =&gt; 100.000%
100.to_s(:percentage, precision: 0)
# =&gt; 100%
1000.to_s(:percentage, delimiter: '.', separator: ',')
# =&gt; 1.000,000%
302.24398923423.to_s(:percentage, precision: 5)
# =&gt; 302.24399%

</pre>
</div>
<p>Produce a string representation of a number in delimited form:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
12345678.to_s(:delimited)                     # =&gt; 12,345,678
12345678.05.to_s(:delimited)                  # =&gt; 12,345,678.05
12345678.to_s(:delimited, delimiter: ".")     # =&gt; 12.345.678
12345678.to_s(:delimited, delimiter: ",")     # =&gt; 12,345,678
12345678.05.to_s(:delimited, separator: " ")  # =&gt; 12,345,678 05

</pre>
</div>
<p>Produce a string representation of a number rounded to a precision:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
111.2345.to_s(:rounded)                     # =&gt; 111.235
111.2345.to_s(:rounded, precision: 2)       # =&gt; 111.23
13.to_s(:rounded, precision: 5)             # =&gt; 13.00000
389.32314.to_s(:rounded, precision: 0)      # =&gt; 389
111.2345.to_s(:rounded, significant: true)  # =&gt; 111

</pre>
</div>
<p>Produce a string representation of a number as a human-readable number of bytes:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
123.to_s(:human_size)            # =&gt; 123 Bytes
1234.to_s(:human_size)           # =&gt; 1.21 KB
12345.to_s(:human_size)          # =&gt; 12.1 KB
1234567.to_s(:human_size)        # =&gt; 1.18 MB
1234567890.to_s(:human_size)     # =&gt; 1.15 GB
1234567890123.to_s(:human_size)  # =&gt; 1.12 TB

</pre>
</div>
<p>Produce a string representation of a number in human-readable words:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
123.to_s(:human)               # =&gt; "123"
1234.to_s(:human)              # =&gt; "1.23 Thousand"
12345.to_s(:human)             # =&gt; "12.3 Thousand"
1234567.to_s(:human)           # =&gt; "1.23 Million"
1234567890.to_s(:human)        # =&gt; "1.23 Billion"
1234567890123.to_s(:human)     # =&gt; "1.23 Trillion"
1234567890123456.to_s(:human)  # =&gt; "1.23 Quadrillion"

</pre>
</div>
<div class="note"><p>定义于 <code>active_support/core_ext/numeric/conversions.rb</code>.</p></div><h3 id="extensions-to-integer">7 Extensions to <code>Integer</code>
</h3><h4 id="multiple_of-questionmark">7.1 <code>multiple_of?</code>
</h4><p>The method <code>multiple_of?</code> tests whether an integer is multiple of the argument:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
2.multiple_of?(1) # =&gt; true
1.multiple_of?(2) # =&gt; false

</pre>
</div>
<div class="note"><p>定义于 <code>active_support/core_ext/integer/multiple.rb</code>.</p></div><h4 id="ordinal">7.2 <code>ordinal</code>
</h4><p>The method <code>ordinal</code> returns the ordinal suffix string corresponding to the receiver integer:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
1.ordinal    # =&gt; "st"
2.ordinal    # =&gt; "nd"
53.ordinal   # =&gt; "rd"
2009.ordinal # =&gt; "th"
-21.ordinal  # =&gt; "st"
-134.ordinal # =&gt; "th"

</pre>
</div>
<div class="note"><p>定义于 <code>active_support/core_ext/integer/inflections.rb</code>.</p></div><h4 id="ordinalize">7.3 <code>ordinalize</code>
</h4><p>The method <code>ordinalize</code> returns the ordinal string corresponding to the receiver integer. In comparison, note that the <code>ordinal</code> method returns <strong>only</strong> the suffix string.</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
1.ordinalize    # =&gt; "1st"
2.ordinalize    # =&gt; "2nd"
53.ordinalize   # =&gt; "53rd"
2009.ordinalize # =&gt; "2009th"
-21.ordinalize  # =&gt; "-21st"
-134.ordinalize # =&gt; "-134th"

</pre>
</div>
<div class="note"><p>定义于 <code>active_support/core_ext/integer/inflections.rb</code>.</p></div><h3 id="extensions-to-bigdecimal">8 Extensions to <code>BigDecimal</code>
</h3><h4 id="extensions-to-bigdecimal-to_s">8.1 <code>to_s</code>
</h4><p>The method <code>to_s</code> is aliased to <code>to_formatted_s</code>. This provides a convenient way to display a BigDecimal value in floating-point notation:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
BigDecimal.new(5.00, 6).to_s  # =&gt; "5.0"

</pre>
</div>
<h4 id="extensions-to-bigdecimal-to_formatted_s">8.2 <code>to_formatted_s</code>
</h4><p>Te method <code>to_formatted_s</code> provides a default specifier of "F".  This means that a simple call to <code>to_formatted_s</code> or <code>to_s</code> will result in floating point representation instead of engineering notation:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
BigDecimal.new(5.00, 6).to_formatted_s  # =&gt; "5.0"

</pre>
</div>
<p>and that symbol specifiers are also supported:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
BigDecimal.new(5.00, 6).to_formatted_s(:db)  # =&gt; "5.0"

</pre>
</div>
<p>Engineering notation is still supported:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
BigDecimal.new(5.00, 6).to_formatted_s("e")  # =&gt; "0.5E1"

</pre>
</div>
<h3 id="extensions-to-enumerable">9 Extensions to <code>Enumerable</code>
</h3><h4 id="sum">9.1 <code>sum</code>
</h4><p>The method <code>sum</code> adds the elements of an enumerable:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
[1, 2, 3].sum # =&gt; 6
(1..100).sum  # =&gt; 5050

</pre>
</div>
<p>Addition only assumes the elements respond to <code>+</code>:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
[[1, 2], [2, 3], [3, 4]].sum    # =&gt; [1, 2, 2, 3, 3, 4]
%w(foo bar baz).sum             # =&gt; "foobarbaz"
{a: 1, b: 2, c: 3}.sum # =&gt; [:b, 2, :c, 3, :a, 1]

</pre>
</div>
<p>The sum of an empty collection is zero by default, but this is customizable:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
[].sum    # =&gt; 0
[].sum(1) # =&gt; 1

</pre>
</div>
<p>If a block is given, <code>sum</code> becomes an iterator that yields the elements of the collection and sums the returned values:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
(1..5).sum {|n| n * 2 } # =&gt; 30
[2, 4, 6, 8, 10].sum    # =&gt; 30

</pre>
</div>
<p>The sum of an empty receiver can be customized in this form as well:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
[].sum(1) {|n| n**3} # =&gt; 1

</pre>
</div>
<div class="note"><p>定义于 <code>active_support/core_ext/enumerable.rb</code>.</p></div><h4 id="index_by">9.2 <code>index_by</code>
</h4><p>The method <code>index_by</code> generates a hash with the elements of an enumerable indexed by some key.</p><p>It iterates through the collection and passes each element to a block. The element will be keyed by the value returned by the block:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
invoices.index_by(&amp;:number)
# =&gt; {'2009-032' =&gt; &lt;Invoice ...&gt;, '2009-008' =&gt; &lt;Invoice ...&gt;, ...}

</pre>
</div>
<div class="warning"><p>Keys should normally be unique. If the block returns the same value for different elements no collection is built for that key. The last item will win.</p></div><div class="note"><p>定义于 <code>active_support/core_ext/enumerable.rb</code>.</p></div><h4 id="many-questionmark">9.3 <code>many?</code>
</h4><p>The method <code>many?</code> is shorthand for <code>collection.size &gt; 1</code>:</p><div class="code_container">
<pre class="brush: ruby; html-script: true; gutter: false; toolbar: false">
&lt;% if pages.many? %&gt;
  &lt;%= pagination_links %&gt;
&lt;% end %&gt;

</pre>
</div>
<p>If an optional block is given, <code>many?</code> only takes into account those elements that return true:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
@see_more = videos.many? {|video| video.category == params[:category]}

</pre>
</div>
<div class="note"><p>定义于 <code>active_support/core_ext/enumerable.rb</code>.</p></div><h4 id="exclude-questionmark">9.4 <code>exclude?</code>
</h4><p>The predicate <code>exclude?</code> tests whether a given object does <strong>not</strong> belong to the collection. It is the negation of the built-in <code>include?</code>:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
to_visit &lt;&lt; node if visited.exclude?(node)

</pre>
</div>
<div class="note"><p>定义于 <code>active_support/core_ext/enumerable.rb</code>.</p></div><h3 id="extensions-to-array">10 Extensions to <code>Array</code>
</h3><h4 id="accessing">10.1 Accessing</h4><p>Active Support augments the API of arrays to ease certain ways of accessing them. For example, <code>to</code> returns the subarray of elements up to the one at the passed index:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
%w(a b c d).to(2) # =&gt; %w(a b c)
[].to(7)          # =&gt; []

</pre>
</div>
<p>Similarly, <code>from</code> returns the tail from the element at the passed index to the end. If the index is greater than the length of the array, it returns an empty array.</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
%w(a b c d).from(2)  # =&gt; %w(c d)
%w(a b c d).from(10) # =&gt; []
[].from(0)           # =&gt; []

</pre>
</div>
<p>The methods <code>second</code>, <code>third</code>, <code>fourth</code>, and <code>fifth</code> return the corresponding element (<code>first</code> is built-in). Thanks to social wisdom and positive constructiveness all around, <code>forty_two</code> is also available.</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
%w(a b c d).third # =&gt; c
%w(a b c d).fifth # =&gt; nil

</pre>
</div>
<div class="note"><p>定义于 <code>active_support/core_ext/array/access.rb</code>.</p></div><h4 id="adding-elements">10.2 Adding Elements</h4><h5 id="prepend">10.2.1 <code>prepend</code>
</h5><p>This method is an alias of <code>Array#unshift</code>.</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
%w(a b c d).prepend('e')  # =&gt; %w(e a b c d)
[].prepend(10)            # =&gt; [10]

</pre>
</div>
<div class="note"><p>定义于 <code>active_support/core_ext/array/prepend_and_append.rb</code>.</p></div><h5 id="append">10.2.2 <code>append</code>
</h5><p>This method is an alias of <code>Array#&lt;&lt;</code>.</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
%w(a b c d).append('e')  # =&gt; %w(a b c d e)
[].append([1,2])         # =&gt; [[1,2]]

</pre>
</div>
<div class="note"><p>定义于 <code>active_support/core_ext/array/prepend_and_append.rb</code>.</p></div><h4 id="options-extraction">10.3 Options Extraction</h4><p>When the last argument in a method call is a hash, except perhaps for a <code>&amp;block</code> argument, Ruby allows you to omit the brackets:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
User.exists?(email: params[:email])

</pre>
</div>
<p>That syntactic sugar is used a lot in Rails to avoid positional arguments where there would be too many, offering instead interfaces that emulate named parameters. In particular it is very idiomatic to use a trailing hash for options.</p><p>If a method expects a variable number of arguments and uses <code>*</code> in its declaration, however, such an options hash ends up being an item of the array of arguments, where it loses its role.</p><p>In those cases, you may give an options hash a distinguished treatment with <code>extract_options!</code>. This method checks the type of the last item of an array. If it is a hash it pops it and returns it, otherwise it returns an empty hash.</p><p>Let's see for example the definition of the <code>caches_action</code> controller macro:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
def caches_action(*actions)
  return unless cache_configured?
  options = actions.extract_options!
  ...
end

</pre>
</div>
<p>This method receives an arbitrary number of action names, and an optional hash of options as last argument. With the call to <code>extract_options!</code> you obtain the options hash and remove it from <code>actions</code> in a simple and explicit way.</p><div class="note"><p>定义于 <code>active_support/core_ext/array/extract_options.rb</code>.</p></div><h4 id="extensions-to-array-conversions">10.4 Conversions</h4><h5 id="to_sentence">10.4.1 <code>to_sentence</code>
</h5><p>The method <code>to_sentence</code> turns an array into a string containing a sentence that enumerates its items:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
%w().to_sentence                # =&gt; ""
%w(Earth).to_sentence           # =&gt; "Earth"
%w(Earth Wind).to_sentence      # =&gt; "Earth and Wind"
%w(Earth Wind Fire).to_sentence # =&gt; "Earth, Wind, and Fire"

</pre>
</div>
<p>This method accepts three options:</p>
<ul>
<li>
<code>:two_words_connector</code>: What is used for arrays of length 2. Default is " and ".</li>
<li>
<code>:words_connector</code>: What is used to join the elements of arrays with 3 or more elements, except for the last two. Default is ", ".</li>
<li>
<code>:last_word_connector</code>: What is used to join the last items of an array with 3 or more elements. Default is ", and ".</li>
</ul>
<p>The defaults for these options can be localized, their keys are:</p>
<table>
<thead>
<tr>
<th>Option</th>
<th>I18n key</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>:two_words_connector</code></td>
<td><code>support.array.two_words_connector</code></td>
</tr>
<tr>
<td><code>:words_connector</code></td>
<td><code>support.array.words_connector</code></td>
</tr>
<tr>
<td><code>:last_word_connector</code></td>
<td><code>support.array.last_word_connector</code></td>
</tr>
</tbody>
</table>
<div class="note"><p>定义于 <code>active_support/core_ext/array/conversions.rb</code>.</p></div><h5 id="extensions-to-array-conversions-to_formatted_s">10.4.2 <code>to_formatted_s</code>
</h5><p>The method <code>to_formatted_s</code> acts like <code>to_s</code> by default.</p><p>If the array contains items that respond to <code>id</code>, however, the symbol
<code>:db</code> may be passed as argument. That's typically used with
collections of Active Record objects. Returned strings are:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
[].to_formatted_s(:db)            # =&gt; "null"
[user].to_formatted_s(:db)        # =&gt; "8456"
invoice.lines.to_formatted_s(:db) # =&gt; "23,567,556,12"

</pre>
</div>
<p>Integers in the example above are supposed to come from the respective calls to <code>id</code>.</p><div class="note"><p>定义于 <code>active_support/core_ext/array/conversions.rb</code>.</p></div><h5 id="extensions-to-array-conversions-to_xml">10.4.3 <code>to_xml</code>
</h5><p>The method <code>to_xml</code> returns a string containing an XML representation of its receiver:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
Contributor.limit(2).order(:rank).to_xml
# =&gt;
# &lt;?xml version="1.0" encoding="UTF-8"?&gt;
# &lt;contributors type="array"&gt;
#   &lt;contributor&gt;
#     &lt;id type="integer"&gt;4356&lt;/id&gt;
#     &lt;name&gt;Jeremy Kemper&lt;/name&gt;
#     &lt;rank type="integer"&gt;1&lt;/rank&gt;
#     &lt;url-id&gt;jeremy-kemper&lt;/url-id&gt;
#   &lt;/contributor&gt;
#   &lt;contributor&gt;
#     &lt;id type="integer"&gt;4404&lt;/id&gt;
#     &lt;name&gt;David Heinemeier Hansson&lt;/name&gt;
#     &lt;rank type="integer"&gt;2&lt;/rank&gt;
#     &lt;url-id&gt;david-heinemeier-hansson&lt;/url-id&gt;
#   &lt;/contributor&gt;
# &lt;/contributors&gt;

</pre>
</div>
<p>To do so it sends <code>to_xml</code> to every item in turn, and collects the results under a root node. All items must respond to <code>to_xml</code>, an exception is raised otherwise.</p><p>By default, the name of the root element is the underscorized and dasherized plural of the name of the class of the first item, provided the rest of elements belong to that type (checked with <code>is_a?</code>) and they are not hashes. In the example above that's "contributors".</p><p>If there's any element that does not belong to the type of the first one the root node becomes "objects":</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
[Contributor.first, Commit.first].to_xml
# =&gt;
# &lt;?xml version="1.0" encoding="UTF-8"?&gt;
# &lt;objects type="array"&gt;
#   &lt;object&gt;
#     &lt;id type="integer"&gt;4583&lt;/id&gt;
#     &lt;name&gt;Aaron Batalion&lt;/name&gt;
#     &lt;rank type="integer"&gt;53&lt;/rank&gt;
#     &lt;url-id&gt;aaron-batalion&lt;/url-id&gt;
#   &lt;/object&gt;
#   &lt;object&gt;
#     &lt;author&gt;Joshua Peek&lt;/author&gt;
#     &lt;authored-timestamp type="datetime"&gt;2009-09-02T16:44:36Z&lt;/authored-timestamp&gt;
#     &lt;branch&gt;origin/master&lt;/branch&gt;
#     &lt;committed-timestamp type="datetime"&gt;2009-09-02T16:44:36Z&lt;/committed-timestamp&gt;
#     &lt;committer&gt;Joshua Peek&lt;/committer&gt;
#     &lt;git-show nil="true"&gt;&lt;/git-show&gt;
#     &lt;id type="integer"&gt;190316&lt;/id&gt;
#     &lt;imported-from-svn type="boolean"&gt;false&lt;/imported-from-svn&gt;
#     &lt;message&gt;Kill AMo observing wrap_with_notifications since ARes was only using it&lt;/message&gt;
#     &lt;sha1&gt;723a47bfb3708f968821bc969a9a3fc873a3ed58&lt;/sha1&gt;
#   &lt;/object&gt;
# &lt;/objects&gt;

</pre>
</div>
<p>If the receiver is an array of hashes the root element is by default also "objects":</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
[{a: 1, b: 2}, {c: 3}].to_xml
# =&gt;
# &lt;?xml version="1.0" encoding="UTF-8"?&gt;
# &lt;objects type="array"&gt;
#   &lt;object&gt;
#     &lt;b type="integer"&gt;2&lt;/b&gt;
#     &lt;a type="integer"&gt;1&lt;/a&gt;
#   &lt;/object&gt;
#   &lt;object&gt;
#     &lt;c type="integer"&gt;3&lt;/c&gt;
#   &lt;/object&gt;
# &lt;/objects&gt;

</pre>
</div>
<div class="warning"><p>If the collection is empty the root element is by default "nil-classes". That's a gotcha, for example the root element of the list of contributors above would not be "contributors" if the collection was empty, but "nil-classes". You may use the <code>:root</code> option to ensure a consistent root element.</p></div><p>The name of children nodes is by default the name of the root node singularized. In the examples above we've seen "contributor" and "object". The option <code>:children</code> allows you to set these node names.</p><p>The default XML builder is a fresh instance of <code>Builder::XmlMarkup</code>. You can configure your own builder via the <code>:builder</code> option. The method also accepts options like <code>:dasherize</code> and friends, they are forwarded to the builder:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
Contributor.limit(2).order(:rank).to_xml(skip_types: true)
# =&gt;
# &lt;?xml version="1.0" encoding="UTF-8"?&gt;
# &lt;contributors&gt;
#   &lt;contributor&gt;
#     &lt;id&gt;4356&lt;/id&gt;
#     &lt;name&gt;Jeremy Kemper&lt;/name&gt;
#     &lt;rank&gt;1&lt;/rank&gt;
#     &lt;url-id&gt;jeremy-kemper&lt;/url-id&gt;
#   &lt;/contributor&gt;
#   &lt;contributor&gt;
#     &lt;id&gt;4404&lt;/id&gt;
#     &lt;name&gt;David Heinemeier Hansson&lt;/name&gt;
#     &lt;rank&gt;2&lt;/rank&gt;
#     &lt;url-id&gt;david-heinemeier-hansson&lt;/url-id&gt;
#   &lt;/contributor&gt;
# &lt;/contributors&gt;

</pre>
</div>
<div class="note"><p>定义于 <code>active_support/core_ext/array/conversions.rb</code>.</p></div><h4 id="wrapping">10.5 Wrapping</h4><p>The method <code>Array.wrap</code> wraps its argument in an array unless it is already an array (or array-like).</p><p>Specifically:</p>
<ul>
<li>If the argument is <code>nil</code> an empty list is returned.</li>
<li>Otherwise, if the argument responds to <code>to_ary</code> it is invoked, and if the value of <code>to_ary</code> is not <code>nil</code>, it is returned.</li>
<li>Otherwise, an array with the argument as its single element is returned.</li>
</ul>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
Array.wrap(nil)       # =&gt; []
Array.wrap([1, 2, 3]) # =&gt; [1, 2, 3]
Array.wrap(0)         # =&gt; [0]

</pre>
</div>
<p>This method is similar in purpose to <code>Kernel#Array</code>, but there are some differences:</p>
<ul>
<li>If the argument responds to <code>to_ary</code> the method is invoked. <code>Kernel#Array</code> moves on to try <code>to_a</code> if the returned value is <code>nil</code>, but <code>Array.wrap</code> returns <code>nil</code> right away.</li>
<li>If the returned value from <code>to_ary</code> is neither <code>nil</code> nor an <code>Array</code> object, <code>Kernel#Array</code> raises an exception, while <code>Array.wrap</code> does not, it just returns the value.</li>
<li>It does not call <code>to_a</code> on the argument, though special-cases <code>nil</code> to return an empty array.</li>
</ul>
<p>The last point is particularly worth comparing for some enumerables:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
Array.wrap(foo: :bar) # =&gt; [{:foo=&gt;:bar}]
Array(foo: :bar)      # =&gt; [[:foo, :bar]]

</pre>
</div>
<p>There's also a related idiom that uses the splat operator:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
[*object]

</pre>
</div>
<p>which in Ruby 1.8 returns <code>[nil]</code> for <code>nil</code>, and calls to <code>Array(object)</code> otherwise. (Please if you know the exact behavior in 1.9 contact fxn.)</p><p>Thus, in this case the behavior is different for <code>nil</code>, and the differences with <code>Kernel#Array</code> explained above apply to the rest of <code>object</code>s.</p><div class="note"><p>定义于 <code>active_support/core_ext/array/wrap.rb</code>.</p></div><h4 id="duplicating">10.6 Duplicating</h4><p>The method <code>Array.deep_dup</code> duplicates itself and all objects inside
recursively with Active Support method <code>Object#deep_dup</code>. It works like <code>Array#map</code> with sending <code>deep_dup</code> method to each object inside.</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
array = [1, [2, 3]]
dup = array.deep_dup
dup[1][2] = 4
array[1][2] == nil   # =&gt; true

</pre>
</div>
<div class="note"><p>定义于 <code>active_support/core_ext/object/deep_dup.rb</code>.</p></div><h4 id="grouping">10.7 Grouping</h4><h5 id="in_groups_of(number,-fill_with-=-nil)">10.7.1 <code>in_groups_of(number, fill_with = nil)</code>
</h5><p>The method <code>in_groups_of</code> splits an array into consecutive groups of a certain size. It returns an array with the groups:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
[1, 2, 3].in_groups_of(2) # =&gt; [[1, 2], [3, nil]]

</pre>
</div>
<p>or yields them in turn if a block is passed:</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
&lt;% sample.in_groups_of(3) do |a, b, c| %&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;%= a %&gt;&lt;/td&gt;
    &lt;td&gt;&lt;%= b %&gt;&lt;/td&gt;
    &lt;td&gt;&lt;%= c %&gt;&lt;/td&gt;
  &lt;/tr&gt;
&lt;% end %&gt;

</pre>
</div>
<p>The first example shows <code>in_groups_of</code> fills the last group with as many <code>nil</code> elements as needed to have the requested size. You can change this padding value using the second optional argument:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
[1, 2, 3].in_groups_of(2, 0) # =&gt; [[1, 2], [3, 0]]

</pre>
</div>
<p>And you can tell the method not to fill the last group passing <code>false</code>:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
[1, 2, 3].in_groups_of(2, false) # =&gt; [[1, 2], [3]]

</pre>
</div>
<p>As a consequence <code>false</code> can't be a used as a padding value.</p><div class="note"><p>定义于 <code>active_support/core_ext/array/grouping.rb</code>.</p></div><h5 id="in_groups(number,-fill_with-=-nil)">10.7.2 <code>in_groups(number, fill_with = nil)</code>
</h5><p>The method <code>in_groups</code> splits an array into a certain number of groups. The method returns an array with the groups:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
%w(1 2 3 4 5 6 7).in_groups(3)
# =&gt; [["1", "2", "3"], ["4", "5", nil], ["6", "7", nil]]

</pre>
</div>
<p>or yields them in turn if a block is passed:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
%w(1 2 3 4 5 6 7).in_groups(3) {|group| p group}
["1", "2", "3"]
["4", "5", nil]
["6", "7", nil]

</pre>
</div>
<p>The examples above show that <code>in_groups</code> fills some groups with a trailing <code>nil</code> element as needed. A group can get at most one of these extra elements, the rightmost one if any. And the groups that have them are always the last ones.</p><p>You can change this padding value using the second optional argument:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
%w(1 2 3 4 5 6 7).in_groups(3, "0")
# =&gt; [["1", "2", "3"], ["4", "5", "0"], ["6", "7", "0"]]

</pre>
</div>
<p>And you can tell the method not to fill the smaller groups passing <code>false</code>:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
%w(1 2 3 4 5 6 7).in_groups(3, false)
# =&gt; [["1", "2", "3"], ["4", "5"], ["6", "7"]]

</pre>
</div>
<p>As a consequence <code>false</code> can't be a used as a padding value.</p><div class="note"><p>定义于 <code>active_support/core_ext/array/grouping.rb</code>.</p></div><h5 id="split(value-=-nil)">10.7.3 <code>split(value = nil)</code>
</h5><p>The method <code>split</code> divides an array by a separator and returns the resulting chunks.</p><p>If a block is passed the separators are those elements of the array for which the block returns true:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
(-5..5).to_a.split { |i| i.multiple_of?(4) }
# =&gt; [[-5], [-3, -2, -1], [1, 2, 3], [5]]

</pre>
</div>
<p>Otherwise, the value received as argument, which defaults to <code>nil</code>, is the separator:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
[0, 1, -5, 1, 1, "foo", "bar"].split(1)
# =&gt; [[0], [-5], [], ["foo", "bar"]]

</pre>
</div>
<div class="info"><p>Observe in the previous example that consecutive separators result in empty arrays.</p></div><div class="note"><p>定义于 <code>active_support/core_ext/array/grouping.rb</code>.</p></div><h3 id="extensions-to-hash">11 Extensions to <code>Hash</code>
</h3><h4 id="extensions-to-hash-conversions">11.1 Conversions</h4><h5 id="conversions-to_xml">11.1.1 <code>to_xml</code>
</h5><p>The method <code>to_xml</code> returns a string containing an XML representation of its receiver:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
{"foo" =&gt; 1, "bar" =&gt; 2}.to_xml
# =&gt;
# &lt;?xml version="1.0" encoding="UTF-8"?&gt;
# &lt;hash&gt;
#   &lt;foo type="integer"&gt;1&lt;/foo&gt;
#   &lt;bar type="integer"&gt;2&lt;/bar&gt;
# &lt;/hash&gt;

</pre>
</div>
<p>To do so, the method loops over the pairs and builds nodes that depend on the <em>values</em>. Given a pair <code>key</code>, <code>value</code>:</p>
<ul>
<li><p>If <code>value</code> is a hash there's a recursive call with <code>key</code> as <code>:root</code>.</p></li>
<li><p>If <code>value</code> is an array there's a recursive call with <code>key</code> as <code>:root</code>, and <code>key</code> singularized as <code>:children</code>.</p></li>
<li><p>If <code>value</code> is a callable object it must expect one or two arguments. Depending on the arity, the callable is invoked with the <code>options</code> hash as first argument with <code>key</code> as <code>:root</code>, and <code>key</code> singularized as second argument. Its return value becomes a new node.</p></li>
<li><p>If <code>value</code> responds to <code>to_xml</code> the method is invoked with <code>key</code> as <code>:root</code>.</p></li>
<li><p>Otherwise, a node with <code>key</code> as tag is created with a string representation of <code>value</code> as text node. If <code>value</code> is <code>nil</code> an attribute "nil" set to "true" is added. Unless the option <code>:skip_types</code> exists and is true, an attribute "type" is added as well according to the following mapping:</p></li>
</ul>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
XML_TYPE_NAMES = {
  "Symbol"     =&gt; "symbol",
  "Fixnum"     =&gt; "integer",
  "Bignum"     =&gt; "integer",
  "BigDecimal" =&gt; "decimal",
  "Float"      =&gt; "float",
  "TrueClass"  =&gt; "boolean",
  "FalseClass" =&gt; "boolean",
  "Date"       =&gt; "date",
  "DateTime"   =&gt; "datetime",
  "Time"       =&gt; "datetime"
}

</pre>
</div>
<p>By default the root node is "hash", but that's configurable via the <code>:root</code> option.</p><p>The default XML builder is a fresh instance of <code>Builder::XmlMarkup</code>. You can configure your own builder with the <code>:builder</code> option. The method also accepts options like <code>:dasherize</code> and friends, they are forwarded to the builder.</p><div class="note"><p>定义于 <code>active_support/core_ext/hash/conversions.rb</code>.</p></div><h4 id="merging">11.2 Merging</h4><p>Ruby has a built-in method <code>Hash#merge</code> that merges two hashes:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
{a: 1, b: 1}.merge(a: 0, c: 2)
# =&gt; {:a=&gt;0, :b=&gt;1, :c=&gt;2}

</pre>
</div>
<p>Active Support defines a few more ways of merging hashes that may be convenient.</p><h5 id="reverse_merge-and-reverse_merge-bang">11.2.1 <code>reverse_merge</code> and <code>reverse_merge!</code>
</h5><p>In case of collision the key in the hash of the argument wins in <code>merge</code>. You can support option hashes with default values in a compact way with this idiom:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
options = {length: 30, omission: "..."}.merge(options)

</pre>
</div>
<p>Active Support defines <code>reverse_merge</code> in case you prefer this alternative notation:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
options = options.reverse_merge(length: 30, omission: "...")

</pre>
</div>
<p>And a bang version <code>reverse_merge!</code> that performs the merge in place:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
options.reverse_merge!(length: 30, omission: "...")

</pre>
</div>
<div class="warning"><p>Take into account that <code>reverse_merge!</code> may change the hash in the caller, which may or may not be a good idea.</p></div><div class="note"><p>定义于 <code>active_support/core_ext/hash/reverse_merge.rb</code>.</p></div><h5 id="reverse_update">11.2.2 <code>reverse_update</code>
</h5><p>The method <code>reverse_update</code> is an alias for <code>reverse_merge!</code>, explained above.</p><div class="warning"><p>Note that <code>reverse_update</code> has no bang.</p></div><div class="note"><p>定义于 <code>active_support/core_ext/hash/reverse_merge.rb</code>.</p></div><h5 id="deep_merge-and-deep_merge-bang">11.2.3 <code>deep_merge</code> and <code>deep_merge!</code>
</h5><p>As you can see in the previous example if a key is found in both hashes the value in the one in the argument wins.</p><p>Active Support defines <code>Hash#deep_merge</code>. In a deep merge, if a key is found in both hashes and their values are hashes in turn, then their <em>merge</em> becomes the value in the resulting hash:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
{a: {b: 1}}.deep_merge(a: {c: 2})
# =&gt; {:a=&gt;{:b=&gt;1, :c=&gt;2}}

</pre>
</div>
<p>The method <code>deep_merge!</code> performs a deep merge in place.</p><div class="note"><p>定义于 <code>active_support/core_ext/hash/deep_merge.rb</code>.</p></div><h4 id="deep-duplicating">11.3 Deep duplicating</h4><p>The method <code>Hash.deep_dup</code> duplicates itself and all keys and values
inside recursively with Active Support method <code>Object#deep_dup</code>. It works like <code>Enumerator#each_with_object</code> with sending <code>deep_dup</code> method to each pair inside.</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
hash = { a: 1, b: { c: 2, d: [3, 4] } }

dup = hash.deep_dup
dup[:b][:e] = 5
dup[:b][:d] &lt;&lt; 5

hash[:b][:e] == nil      # =&gt; true
hash[:b][:d] == [3, 4]   # =&gt; true

</pre>
</div>
<div class="note"><p>定义于 <code>active_support/core_ext/object/deep_dup.rb</code>.</p></div><h4 id="working-with-keys">11.4 Working with Keys</h4><h5 id="except-and-except-bang">11.4.1 <code>except</code> and <code>except!</code>
</h5><p>The method <code>except</code> returns a hash with the keys in the argument list removed, if present:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
{a: 1, b: 2}.except(:a) # =&gt; {:b=&gt;2}

</pre>
</div>
<p>If the receiver responds to <code>convert_key</code>, the method is called on each of the arguments. This allows <code>except</code> to play nice with hashes with indifferent access for instance:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
{a: 1}.with_indifferent_access.except(:a)  # =&gt; {}
{a: 1}.with_indifferent_access.except("a") # =&gt; {}

</pre>
</div>
<p>There's also the bang variant <code>except!</code> that removes keys in the very receiver.</p><div class="note"><p>定义于 <code>active_support/core_ext/hash/except.rb</code>.</p></div><h5 id="transform_keys-and-transform_keys-bang">11.4.2 <code>transform_keys</code> and <code>transform_keys!</code>
</h5><p>The method <code>transform_keys</code> accepts a block and returns a hash that has applied the block operations to each of the keys in the receiver:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
{nil =&gt; nil, 1 =&gt; 1, a: :a}.transform_keys { |key| key.to_s.upcase }
# =&gt; {"" =&gt; nil, "A" =&gt; :a, "1" =&gt; 1}

</pre>
</div>
<p>In case of key collision, one of the values will be chosen. The chosen value may not always be the same given the same hash:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
{"a" =&gt; 1, a: 2}.transform_keys { |key| key.to_s.upcase }
# The result could either be
# =&gt; {"A"=&gt;2}
# or
# =&gt; {"A"=&gt;1}

</pre>
</div>
<p>This method may be useful for example to build specialized conversions. For instance <code>stringify_keys</code> and <code>symbolize_keys</code> use <code>transform_keys</code> to perform their key conversions:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
def stringify_keys
  transform_keys { |key| key.to_s }
end
...
def symbolize_keys
  transform_keys { |key| key.to_sym rescue key }
end

</pre>
</div>
<p>There's also the bang variant <code>transform_keys!</code> that applies the block operations to keys in the very receiver.</p><p>Besides that, one can use <code>deep_transform_keys</code> and <code>deep_transform_keys!</code> to perform the block operation on all the keys in the given hash and all the hashes nested into it. An example of the result is:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
{nil =&gt; nil, 1 =&gt; 1, nested: {a: 3, 5 =&gt; 5}}.deep_transform_keys { |key| key.to_s.upcase }
# =&gt; {""=&gt;nil, "1"=&gt;1, "NESTED"=&gt;{"A"=&gt;3, "5"=&gt;5}}

</pre>
</div>
<div class="note"><p>定义于 <code>active_support/core_ext/hash/keys.rb</code>.</p></div><h5 id="stringify_keys-and-stringify_keys-bang">11.4.3 <code>stringify_keys</code> and <code>stringify_keys!</code>
</h5><p>The method <code>stringify_keys</code> returns a hash that has a stringified version of the keys in the receiver. It does so by sending <code>to_s</code> to them:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
{nil =&gt; nil, 1 =&gt; 1, a: :a}.stringify_keys
# =&gt; {"" =&gt; nil, "a" =&gt; :a, "1" =&gt; 1}

</pre>
</div>
<p>In case of key collision, one of the values will be chosen. The chosen value may not always be the same given the same hash:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
{"a" =&gt; 1, a: 2}.stringify_keys
# The result could either be
# =&gt; {"a"=&gt;2}
# or
# =&gt; {"a"=&gt;1}

</pre>
</div>
<p>This method may be useful for example to easily accept both symbols and strings as options. For instance <code>ActionView::Helpers::FormHelper</code> defines:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
def to_check_box_tag(options = {}, checked_value = "1", unchecked_value = "0")
  options = options.stringify_keys
  options["type"] = "checkbox"
  ...
end

</pre>
</div>
<p>The second line can safely access the "type" key, and let the user to pass either <code>:type</code> or "type".</p><p>There's also the bang variant <code>stringify_keys!</code> that stringifies keys in the very receiver.</p><p>Besides that, one can use <code>deep_stringify_keys</code> and <code>deep_stringify_keys!</code> to stringify all the keys in the given hash and all the hashes nested into it. An example of the result is:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
{nil =&gt; nil, 1 =&gt; 1, nested: {a: 3, 5 =&gt; 5}}.deep_stringify_keys
# =&gt; {""=&gt;nil, "1"=&gt;1, "nested"=&gt;{"a"=&gt;3, "5"=&gt;5}}

</pre>
</div>
<div class="note"><p>定义于 <code>active_support/core_ext/hash/keys.rb</code>.</p></div><h5 id="symbolize_keys-and-symbolize_keys-bang">11.4.4 <code>symbolize_keys</code> and <code>symbolize_keys!</code>
</h5><p>The method <code>symbolize_keys</code> returns a hash that has a symbolized version of the keys in the receiver, where possible. It does so by sending <code>to_sym</code> to them:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
{nil =&gt; nil, 1 =&gt; 1, "a" =&gt; "a"}.symbolize_keys
# =&gt; {1=&gt;1, nil=&gt;nil, :a=&gt;"a"}

</pre>
</div>
<div class="warning"><p>Note in the previous example only one key was symbolized.</p></div><p>In case of key collision, one of the values will be chosen. The chosen value may not always be the same given the same hash:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
{"a" =&gt; 1, a: 2}.symbolize_keys
# The result could either be
# =&gt; {:a=&gt;2}
# or
# =&gt; {:a=&gt;1}

</pre>
</div>
<p>This method may be useful for example to easily accept both symbols and strings as options. For instance <code>ActionController::UrlRewriter</code> defines</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
def rewrite_path(options)
  options = options.symbolize_keys
  options.update(options[:params].symbolize_keys) if options[:params]
  ...
end

</pre>
</div>
<p>The second line can safely access the <code>:params</code> key, and let the user to pass either <code>:params</code> or "params".</p><p>There's also the bang variant <code>symbolize_keys!</code> that symbolizes keys in the very receiver.</p><p>Besides that, one can use <code>deep_symbolize_keys</code> and <code>deep_symbolize_keys!</code> to symbolize all the keys in the given hash and all the hashes nested into it. An example of the result is:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
{nil =&gt; nil, 1 =&gt; 1, "nested" =&gt; {"a" =&gt; 3, 5 =&gt; 5}}.deep_symbolize_keys
# =&gt; {nil=&gt;nil, 1=&gt;1, nested:{a:3, 5=&gt;5}}

</pre>
</div>
<div class="note"><p>定义于 <code>active_support/core_ext/hash/keys.rb</code>.</p></div><h5 id="to_options-and-to_options-bang">11.4.5 <code>to_options</code> and <code>to_options!</code>
</h5><p>The methods <code>to_options</code> and <code>to_options!</code> are respectively aliases of <code>symbolize_keys</code> and <code>symbolize_keys!</code>.</p><div class="note"><p>定义于 <code>active_support/core_ext/hash/keys.rb</code>.</p></div><h5 id="assert_valid_keys">11.4.6 <code>assert_valid_keys</code>
</h5><p>The method <code>assert_valid_keys</code> receives an arbitrary number of arguments, and checks whether the receiver has any key outside that white list. If it does <code>ArgumentError</code> is raised.</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
{a: 1}.assert_valid_keys(:a)  # passes
{a: 1}.assert_valid_keys("a") # ArgumentError

</pre>
</div>
<p>Active Record does not accept unknown options when building associations, for example. It implements that control via <code>assert_valid_keys</code>.</p><div class="note"><p>定义于 <code>active_support/core_ext/hash/keys.rb</code>.</p></div><h4 id="slicing">11.5 Slicing</h4><p>Ruby has built-in support for taking slices out of strings and arrays. Active Support extends slicing to hashes:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
{a: 1, b: 2, c: 3}.slice(:a, :c)
# =&gt; {:c=&gt;3, :a=&gt;1}

{a: 1, b: 2, c: 3}.slice(:b, :X)
# =&gt; {:b=&gt;2} # non-existing keys are ignored

</pre>
</div>
<p>If the receiver responds to <code>convert_key</code> keys are normalized:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
{a: 1, b: 2}.with_indifferent_access.slice("a")
# =&gt; {:a=&gt;1}

</pre>
</div>
<div class="note"><p>Slicing may come in handy for sanitizing option hashes with a white list of keys.</p></div><p>There's also <code>slice!</code> which in addition to perform a slice in place returns what's removed:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
hash = {a: 1, b: 2}
rest = hash.slice!(:a) # =&gt; {:b=&gt;2}
hash                   # =&gt; {:a=&gt;1}

</pre>
</div>
<div class="note"><p>定义于 <code>active_support/core_ext/hash/slice.rb</code>.</p></div><h4 id="extracting">11.6 Extracting</h4><p>The method <code>extract!</code> removes and returns the key/value pairs matching the given keys.</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
hash = {a: 1, b: 2}
rest = hash.extract!(:a) # =&gt; {:a=&gt;1}
hash                     # =&gt; {:b=&gt;2}

</pre>
</div>
<p>The method <code>extract!</code> returns the same subclass of Hash, that the receiver is.</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
hash = {a: 1, b: 2}.with_indifferent_access
rest = hash.extract!(:a).class
# =&gt; ActiveSupport::HashWithIndifferentAccess

</pre>
</div>
<div class="note"><p>定义于 <code>active_support/core_ext/hash/slice.rb</code>.</p></div><h4 id="indifferent-access">11.7 Indifferent Access</h4><p>The method <code>with_indifferent_access</code> returns an <code>ActiveSupport::HashWithIndifferentAccess</code> out of its receiver:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
{a: 1}.with_indifferent_access["a"] # =&gt; 1

</pre>
</div>
<div class="note"><p>定义于 <code>active_support/core_ext/hash/indifferent_access.rb</code>.</p></div><h4 id="compacting">11.8 Compacting</h4><p>The methods <code>compact</code> and <code>compact!</code> return a Hash without items with <code>nil</code> value.</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
{a: 1, b: 2, c: nil}.compact # =&gt; {a: 1, b: 2}

</pre>
</div>
<div class="note"><p>定义于 <code>active_support/core_ext/hash/compact.rb</code>.</p></div><h3 id="extensions-to-regexp">12 Extensions to <code>Regexp</code>
</h3><h4 id="multiline-questionmark">12.1 <code>multiline?</code>
</h4><p>The method <code>multiline?</code> says whether a regexp has the <code>/m</code> flag set, that is, whether the dot matches newlines.</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
%r{.}.multiline?  # =&gt; false
%r{.}m.multiline? # =&gt; true

Regexp.new('.').multiline?                    # =&gt; false
Regexp.new('.', Regexp::MULTILINE).multiline? # =&gt; true

</pre>
</div>
<p>Rails uses this method in a single place, also in the routing code. Multiline regexps are disallowed for route requirements and this flag eases enforcing that constraint.</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
def assign_route_options(segments, defaults, requirements)
  ...
  if requirement.multiline?
    raise ArgumentError, "Regexp multiline option not allowed in routing requirements: #{requirement.inspect}"
  end
  ...
end

</pre>
</div>
<div class="note"><p>定义于 <code>active_support/core_ext/regexp.rb</code>.</p></div><h3 id="extensions-to-range">13 Extensions to <code>Range</code>
</h3><h4 id="extensions-to-range-to_s">13.1 <code>to_s</code>
</h4><p>Active Support extends the method <code>Range#to_s</code> so that it understands an optional format argument. As of this writing the only supported non-default format is <code>:db</code>:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
(Date.today..Date.tomorrow).to_s
# =&gt; "2009-10-25..2009-10-26"

(Date.today..Date.tomorrow).to_s(:db)
# =&gt; "BETWEEN '2009-10-25' AND '2009-10-26'"

</pre>
</div>
<p>As the example depicts, the <code>:db</code> format generates a <code>BETWEEN</code> SQL clause. That is used by Active Record in its support for range values in conditions.</p><div class="note"><p>定义于 <code>active_support/core_ext/range/conversions.rb</code>.</p></div><h4 id="include-questionmark">13.2 <code>include?</code>
</h4><p>The methods <code>Range#include?</code> and <code>Range#===</code> say whether some value falls between the ends of a given instance:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
(2..3).include?(Math::E) # =&gt; true

</pre>
</div>
<p>Active Support extends these methods so that the argument may be another range in turn. In that case we test whether the ends of the argument range belong to the receiver themselves:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
(1..10).include?(3..7)  # =&gt; true
(1..10).include?(0..7)  # =&gt; false
(1..10).include?(3..11) # =&gt; false
(1...9).include?(3..9)  # =&gt; false

(1..10) === (3..7)  # =&gt; true
(1..10) === (0..7)  # =&gt; false
(1..10) === (3..11) # =&gt; false
(1...9) === (3..9)  # =&gt; false

</pre>
</div>
<div class="note"><p>定义于 <code>active_support/core_ext/range/include_range.rb</code>.</p></div><h4 id="overlaps-questionmark">13.3 <code>overlaps?</code>
</h4><p>The method <code>Range#overlaps?</code> says whether any two given ranges have non-void intersection:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
(1..10).overlaps?(7..11)  # =&gt; true
(1..10).overlaps?(0..7)   # =&gt; true
(1..10).overlaps?(11..27) # =&gt; false

</pre>
</div>
<div class="note"><p>定义于 <code>active_support/core_ext/range/overlaps.rb</code>.</p></div><h3 id="extensions-to-proc">14 Extensions to <code>Proc</code>
</h3><h4 id="bind">14.1 <code>bind</code>
</h4><p>As you surely know Ruby has an <code>UnboundMethod</code> class whose instances are methods that belong to the limbo of methods without a self. The method <code>Module#instance_method</code> returns an unbound method for example:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
Hash.instance_method(:delete) # =&gt; #&lt;UnboundMethod: Hash#delete&gt;

</pre>
</div>
<p>An unbound method is not callable as is, you need to bind it first to an object with <code>bind</code>:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
clear = Hash.instance_method(:clear)
clear.bind({a: 1}).call # =&gt; {}

</pre>
</div>
<p>Active Support defines <code>Proc#bind</code> with an analogous purpose:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
Proc.new { size }.bind([]).call # =&gt; 0

</pre>
</div>
<p>As you see that's callable and bound to the argument, the return value is indeed a <code>Method</code>.</p><div class="note"><p>To do so <code>Proc#bind</code> actually creates a method under the hood. If you ever see a method with a weird name like <code>__bind_1256598120_237302</code> in a stack trace you know now where it comes from.</p></div><p>Action Pack uses this trick in <code>rescue_from</code> for example, which accepts the name of a method and also a proc as callbacks for a given rescued exception. It has to call them in either case, so a bound method is returned by <code>handler_for_rescue</code>, thus simplifying the code in the caller:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
def handler_for_rescue(exception)
  _, rescuer = Array(rescue_handlers).reverse.detect do |klass_name, handler|
    ...
  end

  case rescuer
  when Symbol
    method(rescuer)
  when Proc
    rescuer.bind(self)
  end
end

</pre>
</div>
<div class="note"><p>定义于 <code>active_support/core_ext/proc.rb</code>.</p></div><h3 id="extensions-to-date">15 Extensions to <code>Date</code>
</h3><h4 id="extensions-to-date-calculations">15.1 Calculations</h4><div class="note"><p>All the following methods are defined in <code>active_support/core_ext/date/calculations.rb</code>.</p></div><div class="info"><p>The following calculation methods have edge cases in October 1582, since days 5..14 just do not exist. This guide does not document their behavior around those days for brevity, but it is enough to say that they do what you would expect. That is, <code>Date.new(1582, 10, 4).tomorrow</code> returns <code>Date.new(1582, 10, 15)</code> and so on. Please check <code>test/core_ext/date_ext_test.rb</code> in the Active Support test suite for expected behavior.</p></div><h5 id="date.current">15.1.1 <code>Date.current</code>
</h5><p>Active Support defines <code>Date.current</code> to be today in the current time zone. That's like <code>Date.today</code>, except that it honors the user time zone, if defined. It also defines <code>Date.yesterday</code> and <code>Date.tomorrow</code>, and the instance predicates <code>past?</code>, <code>today?</code>, and <code>future?</code>, all of them relative to <code>Date.current</code>.</p><p>When making Date comparisons using methods which honor the user time zone, make sure to use <code>Date.current</code> and not <code>Date.today</code>. There are cases where the user time zone might be in the future compared to the system time zone, which <code>Date.today</code> uses by default. This means <code>Date.today</code> may equal <code>Date.yesterday</code>.</p><h5 id="named-dates">15.1.2 Named dates</h5><h6 id="prev_year,-next_year">15.1.2.1 <code>prev_year</code>, <code>next_year</code>
</h6><p>In Ruby 1.9 <code>prev_year</code> and <code>next_year</code> return a date with the same day/month in the last or next year:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
d = Date.new(2010, 5, 8) # =&gt; Sat, 08 May 2010
d.prev_year              # =&gt; Fri, 08 May 2009
d.next_year              # =&gt; Sun, 08 May 2011

</pre>
</div>
<p>If date is the 29th of February of a leap year, you obtain the 28th:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
d = Date.new(2000, 2, 29) # =&gt; Tue, 29 Feb 2000
d.prev_year               # =&gt; Sun, 28 Feb 1999
d.next_year               # =&gt; Wed, 28 Feb 2001

</pre>
</div>
<p><code>prev_year</code> is aliased to <code>last_year</code>.</p><h6 id="prev_month,-next_month">15.1.2.2 <code>prev_month</code>, <code>next_month</code>
</h6><p>In Ruby 1.9 <code>prev_month</code> and <code>next_month</code> return the date with the same day in the last or next month:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
d = Date.new(2010, 5, 8) # =&gt; Sat, 08 May 2010
d.prev_month             # =&gt; Thu, 08 Apr 2010
d.next_month             # =&gt; Tue, 08 Jun 2010

</pre>
</div>
<p>If such a day does not exist, the last day of the corresponding month is returned:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
Date.new(2000, 5, 31).prev_month # =&gt; Sun, 30 Apr 2000
Date.new(2000, 3, 31).prev_month # =&gt; Tue, 29 Feb 2000
Date.new(2000, 5, 31).next_month # =&gt; Fri, 30 Jun 2000
Date.new(2000, 1, 31).next_month # =&gt; Tue, 29 Feb 2000

</pre>
</div>
<p><code>prev_month</code> is aliased to <code>last_month</code>.</p><h6 id="prev_quarter,-next_quarter">15.1.2.3 <code>prev_quarter</code>, <code>next_quarter</code>
</h6><p>Same as <code>prev_month</code> and <code>next_month</code>. It returns the date with the same day in the previous or next quarter:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
t = Time.local(2010, 5, 8) # =&gt; Sat, 08 May 2010
t.prev_quarter             # =&gt; Mon, 08 Feb 2010
t.next_quarter             # =&gt; Sun, 08 Aug 2010

</pre>
</div>
<p>If such a day does not exist, the last day of the corresponding month is returned:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
Time.local(2000, 7, 31).prev_quarter  # =&gt; Sun, 30 Apr 2000
Time.local(2000, 5, 31).prev_quarter  # =&gt; Tue, 29 Feb 2000
Time.local(2000, 10, 31).prev_quarter # =&gt; Mon, 30 Oct 2000
Time.local(2000, 11, 31).next_quarter # =&gt; Wed, 28 Feb 2001

</pre>
</div>
<p><code>prev_quarter</code> is aliased to <code>last_quarter</code>.</p><h6 id="beginning_of_week,-end_of_week">15.1.2.4 <code>beginning_of_week</code>, <code>end_of_week</code>
</h6><p>The methods <code>beginning_of_week</code> and <code>end_of_week</code> return the dates for the
beginning and end of the week, respectively. Weeks are assumed to start on
Monday, but that can be changed passing an argument, setting thread local
<code>Date.beginning_of_week</code> or <code>config.beginning_of_week</code>.</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
d = Date.new(2010, 5, 8)     # =&gt; Sat, 08 May 2010
d.beginning_of_week          # =&gt; Mon, 03 May 2010
d.beginning_of_week(:sunday) # =&gt; Sun, 02 May 2010
d.end_of_week                # =&gt; Sun, 09 May 2010
d.end_of_week(:sunday)       # =&gt; Sat, 08 May 2010

</pre>
</div>
<p><code>beginning_of_week</code> is aliased to <code>at_beginning_of_week</code> and <code>end_of_week</code> is aliased to <code>at_end_of_week</code>.</p><h6 id="monday,-sunday">15.1.2.5 <code>monday</code>, <code>sunday</code>
</h6><p>The methods <code>monday</code> and <code>sunday</code> return the dates for the previous Monday and
next Sunday, respectively.</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
d = Date.new(2010, 5, 8)     # =&gt; Sat, 08 May 2010
d.monday                     # =&gt; Mon, 03 May 2010
d.sunday                     # =&gt; Sun, 09 May 2010

d = Date.new(2012, 9, 10)    # =&gt; Mon, 10 Sep 2012
d.monday                     # =&gt; Mon, 10 Sep 2012

d = Date.new(2012, 9, 16)    # =&gt; Sun, 16 Sep 2012
d.sunday                     # =&gt; Sun, 16 Sep 2012

</pre>
</div>
<h6 id="prev_week,-next_week">15.1.2.6 <code>prev_week</code>, <code>next_week</code>
</h6><p>The method <code>next_week</code> receives a symbol with a day name in English (default is the thread local <code>Date.beginning_of_week</code>, or <code>config.beginning_of_week</code>, or <code>:monday</code>) and it returns the date corresponding to that day.</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
d = Date.new(2010, 5, 9) # =&gt; Sun, 09 May 2010
d.next_week              # =&gt; Mon, 10 May 2010
d.next_week(:saturday)   # =&gt; Sat, 15 May 2010

</pre>
</div>
<p>The method <code>prev_week</code> is analogous:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
d.prev_week              # =&gt; Mon, 26 Apr 2010
d.prev_week(:saturday)   # =&gt; Sat, 01 May 2010
d.prev_week(:friday)     # =&gt; Fri, 30 Apr 2010

</pre>
</div>
<p><code>prev_week</code> is aliased to <code>last_week</code>.</p><p>Both <code>next_week</code> and <code>prev_week</code> work as expected when <code>Date.beginning_of_week</code> or <code>config.beginning_of_week</code> are set.</p><h6 id="beginning_of_month,-end_of_month">15.1.2.7 <code>beginning_of_month</code>, <code>end_of_month</code>
</h6><p>The methods <code>beginning_of_month</code> and <code>end_of_month</code> return the dates for the beginning and end of the month:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
d = Date.new(2010, 5, 9) # =&gt; Sun, 09 May 2010
d.beginning_of_month     # =&gt; Sat, 01 May 2010
d.end_of_month           # =&gt; Mon, 31 May 2010

</pre>
</div>
<p><code>beginning_of_month</code> is aliased to <code>at_beginning_of_month</code>, and <code>end_of_month</code> is aliased to <code>at_end_of_month</code>.</p><h6 id="beginning_of_quarter,-end_of_quarter">15.1.2.8 <code>beginning_of_quarter</code>, <code>end_of_quarter</code>
</h6><p>The methods <code>beginning_of_quarter</code> and <code>end_of_quarter</code> return the dates for the beginning and end of the quarter of the receiver's calendar year:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
d = Date.new(2010, 5, 9) # =&gt; Sun, 09 May 2010
d.beginning_of_quarter   # =&gt; Thu, 01 Apr 2010
d.end_of_quarter         # =&gt; Wed, 30 Jun 2010

</pre>
</div>
<p><code>beginning_of_quarter</code> is aliased to <code>at_beginning_of_quarter</code>, and <code>end_of_quarter</code> is aliased to <code>at_end_of_quarter</code>.</p><h6 id="beginning_of_year,-end_of_year">15.1.2.9 <code>beginning_of_year</code>, <code>end_of_year</code>
</h6><p>The methods <code>beginning_of_year</code> and <code>end_of_year</code> return the dates for the beginning and end of the year:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
d = Date.new(2010, 5, 9) # =&gt; Sun, 09 May 2010
d.beginning_of_year      # =&gt; Fri, 01 Jan 2010
d.end_of_year            # =&gt; Fri, 31 Dec 2010

</pre>
</div>
<p><code>beginning_of_year</code> is aliased to <code>at_beginning_of_year</code>, and <code>end_of_year</code> is aliased to <code>at_end_of_year</code>.</p><h5 id="other-date-computations">15.1.3 Other Date Computations</h5><h6 id="years_ago,-years_since">15.1.3.1 <code>years_ago</code>, <code>years_since</code>
</h6><p>The method <code>years_ago</code> receives a number of years and returns the same date those many years ago:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
date = Date.new(2010, 6, 7)
date.years_ago(10) # =&gt; Wed, 07 Jun 2000

</pre>
</div>
<p><code>years_since</code> moves forward in time:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
date = Date.new(2010, 6, 7)
date.years_since(10) # =&gt; Sun, 07 Jun 2020

</pre>
</div>
<p>If such a day does not exist, the last day of the corresponding month is returned:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
Date.new(2012, 2, 29).years_ago(3)     # =&gt; Sat, 28 Feb 2009
Date.new(2012, 2, 29).years_since(3)   # =&gt; Sat, 28 Feb 2015

</pre>
</div>
<h6 id="months_ago,-months_since">15.1.3.2 <code>months_ago</code>, <code>months_since</code>
</h6><p>The methods <code>months_ago</code> and <code>months_since</code> work analogously for months:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
Date.new(2010, 4, 30).months_ago(2)   # =&gt; Sun, 28 Feb 2010
Date.new(2010, 4, 30).months_since(2) # =&gt; Wed, 30 Jun 2010

</pre>
</div>
<p>If such a day does not exist, the last day of the corresponding month is returned:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
Date.new(2010, 4, 30).months_ago(2)    # =&gt; Sun, 28 Feb 2010
Date.new(2009, 12, 31).months_since(2) # =&gt; Sun, 28 Feb 2010

</pre>
</div>
<h6 id="weeks_ago">15.1.3.3 <code>weeks_ago</code>
</h6><p>The method <code>weeks_ago</code> works analogously for weeks:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
Date.new(2010, 5, 24).weeks_ago(1)    # =&gt; Mon, 17 May 2010
Date.new(2010, 5, 24).weeks_ago(2)    # =&gt; Mon, 10 May 2010

</pre>
</div>
<h6 id="other-date-computations-advance">15.1.3.4 <code>advance</code>
</h6><p>The most generic way to jump to other days is <code>advance</code>. This method receives a hash with keys <code>:years</code>, <code>:months</code>, <code>:weeks</code>, <code>:days</code>, and returns a date advanced as much as the present keys indicate:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
date = Date.new(2010, 6, 6)
date.advance(years: 1, weeks: 2)  # =&gt; Mon, 20 Jun 2011
date.advance(months: 2, days: -2) # =&gt; Wed, 04 Aug 2010

</pre>
</div>
<p>Note in the previous example that increments may be negative.</p><p>To perform the computation the method first increments years, then months, then weeks, and finally days. This order is important towards the end of months. Say for example we are at the end of February of 2010, and we want to move one month and one day forward.</p><p>The method <code>advance</code> advances first one month, and then one day, the result is:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
Date.new(2010, 2, 28).advance(months: 1, days: 1)
# =&gt; Sun, 29 Mar 2010

</pre>
</div>
<p>While if it did it the other way around the result would be different:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
Date.new(2010, 2, 28).advance(days: 1).advance(months: 1)
# =&gt; Thu, 01 Apr 2010

</pre>
</div>
<h5 id="extensions-to-date-calculations-changing-components">15.1.4 Changing Components</h5><p>The method <code>change</code> allows you to get a new date which is the same as the receiver except for the given year, month, or day:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
Date.new(2010, 12, 23).change(year: 2011, month: 11)
# =&gt; Wed, 23 Nov 2011

</pre>
</div>
<p>This method is not tolerant to non-existing dates, if the change is invalid <code>ArgumentError</code> is raised:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
Date.new(2010, 1, 31).change(month: 2)
# =&gt; ArgumentError: invalid date

</pre>
</div>
<h5 id="extensions-to-date-calculations-durations">15.1.5 Durations</h5><p>Durations can be added to and subtracted from dates:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
d = Date.current
# =&gt; Mon, 09 Aug 2010
d + 1.year
# =&gt; Tue, 09 Aug 2011
d - 3.hours
# =&gt; Sun, 08 Aug 2010 21:00:00 UTC +00:00

</pre>
</div>
<p>They translate to calls to <code>since</code> or <code>advance</code>. For example here we get the correct jump in the calendar reform:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
Date.new(1582, 10, 4) + 1.day
# =&gt; Fri, 15 Oct 1582

</pre>
</div>
<h5 id="timestamps">15.1.6 Timestamps</h5><div class="info"><p>The following methods return a <code>Time</code> object if possible, otherwise a <code>DateTime</code>. If set, they honor the user time zone.</p></div><h6 id="beginning_of_day,-end_of_day">15.1.6.1 <code>beginning_of_day</code>, <code>end_of_day</code>
</h6><p>The method <code>beginning_of_day</code> returns a timestamp at the beginning of the day (00:00:00):</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
date = Date.new(2010, 6, 7)
date.beginning_of_day # =&gt; Mon Jun 07 00:00:00 +0200 2010

</pre>
</div>
<p>The method <code>end_of_day</code> returns a timestamp at the end of the day (23:59:59):</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
date = Date.new(2010, 6, 7)
date.end_of_day # =&gt; Mon Jun 07 23:59:59 +0200 2010

</pre>
</div>
<p><code>beginning_of_day</code> is aliased to <code>at_beginning_of_day</code>, <code>midnight</code>, <code>at_midnight</code>.</p><h6 id="beginning_of_hour,-end_of_hour">15.1.6.2 <code>beginning_of_hour</code>, <code>end_of_hour</code>
</h6><p>The method <code>beginning_of_hour</code> returns a timestamp at the beginning of the hour (hh:00:00):</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
date = DateTime.new(2010, 6, 7, 19, 55, 25)
date.beginning_of_hour # =&gt; Mon Jun 07 19:00:00 +0200 2010

</pre>
</div>
<p>The method <code>end_of_hour</code> returns a timestamp at the end of the hour (hh:59:59):</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
date = DateTime.new(2010, 6, 7, 19, 55, 25)
date.end_of_hour # =&gt; Mon Jun 07 19:59:59 +0200 2010

</pre>
</div>
<p><code>beginning_of_hour</code> is aliased to <code>at_beginning_of_hour</code>.</p><h6 id="beginning_of_minute,-end_of_minute">15.1.6.3 <code>beginning_of_minute</code>, <code>end_of_minute</code>
</h6><p>The method <code>beginning_of_minute</code> returns a timestamp at the beginning of the minute (hh:mm:00):</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
date = DateTime.new(2010, 6, 7, 19, 55, 25)
date.beginning_of_minute # =&gt; Mon Jun 07 19:55:00 +0200 2010

</pre>
</div>
<p>The method <code>end_of_minute</code> returns a timestamp at the end of the minute (hh:mm:59):</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
date = DateTime.new(2010, 6, 7, 19, 55, 25)
date.end_of_minute # =&gt; Mon Jun 07 19:55:59 +0200 2010

</pre>
</div>
<p><code>beginning_of_minute</code> is aliased to <code>at_beginning_of_minute</code>.</p><div class="info"><p><code>beginning_of_hour</code>, <code>end_of_hour</code>, <code>beginning_of_minute</code> and <code>end_of_minute</code> are implemented for <code>Time</code> and <code>DateTime</code> but <strong>not</strong> <code>Date</code> as it does not make sense to request the beginning or end of an hour or minute on a <code>Date</code> instance.</p></div><h6 id="ago,-since">15.1.6.4 <code>ago</code>, <code>since</code>
</h6><p>The method <code>ago</code> receives a number of seconds as argument and returns a timestamp those many seconds ago from midnight:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
date = Date.current # =&gt; Fri, 11 Jun 2010
date.ago(1)         # =&gt; Thu, 10 Jun 2010 23:59:59 EDT -04:00

</pre>
</div>
<p>Similarly, <code>since</code> moves forward:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
date = Date.current # =&gt; Fri, 11 Jun 2010
date.since(1)       # =&gt; Fri, 11 Jun 2010 00:00:01 EDT -04:00

</pre>
</div>
<h5 id="other-time-computations">15.1.7 Other Time Computations</h5><h4 id="extensions-to-date-conversions">15.2 Conversions</h4><h3 id="extensions-to-datetime">16 Extensions to <code>DateTime</code>
</h3><div class="warning"><p><code>DateTime</code> is not aware of DST rules and so some of these methods have edge cases when a DST change is going on. For example <code>seconds_since_midnight</code> might not return the real amount in such a day.</p></div><h4 id="extensions-to-datetime-calculations">16.1 Calculations</h4><div class="note"><p>All the following methods are defined in <code>active_support/core_ext/date_time/calculations.rb</code>.</p></div><p>The class <code>DateTime</code> is a subclass of <code>Date</code> so by loading <code>active_support/core_ext/date/calculations.rb</code> you inherit these methods and their aliases, except that they will always return datetimes:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
yesterday
tomorrow
beginning_of_week (at_beginning_of_week)
end_of_week (at_end_of_week)
monday
sunday
weeks_ago
prev_week (last_week)
next_week
months_ago
months_since
beginning_of_month (at_beginning_of_month)
end_of_month (at_end_of_month)
prev_month (last_month)
next_month
beginning_of_quarter (at_beginning_of_quarter)
end_of_quarter (at_end_of_quarter)
beginning_of_year (at_beginning_of_year)
end_of_year (at_end_of_year)
years_ago
years_since
prev_year (last_year)
next_year

</pre>
</div>
<p>The following methods are reimplemented so you do <strong>not</strong> need to load <code>active_support/core_ext/date/calculations.rb</code> for these ones:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
beginning_of_day (midnight, at_midnight, at_beginning_of_day)
end_of_day
ago
since (in)

</pre>
</div>
<p>On the other hand, <code>advance</code> and <code>change</code> are also defined and support more options, they are documented below.</p><p>The following methods are only implemented in <code>active_support/core_ext/date_time/calculations.rb</code> as they only make sense when used with a <code>DateTime</code> instance:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
beginning_of_hour (at_beginning_of_hour)
end_of_hour

</pre>
</div>
<h5 id="named-datetimes">16.1.1 Named Datetimes</h5><h6 id="datetime.current">16.1.1.1 <code>DateTime.current</code>
</h6><p>Active Support defines <code>DateTime.current</code> to be like <code>Time.now.to_datetime</code>, except that it honors the user time zone, if defined. It also defines <code>DateTime.yesterday</code> and <code>DateTime.tomorrow</code>, and the instance predicates <code>past?</code>, and <code>future?</code> relative to <code>DateTime.current</code>.</p><h5 id="other-extensions">16.1.2 Other Extensions</h5><h6 id="seconds_since_midnight">16.1.2.1 <code>seconds_since_midnight</code>
</h6><p>The method <code>seconds_since_midnight</code> returns the number of seconds since midnight:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
now = DateTime.current     # =&gt; Mon, 07 Jun 2010 20:26:36 +0000
now.seconds_since_midnight # =&gt; 73596

</pre>
</div>
<h6 id="utc">16.1.2.2 <code>utc</code>
</h6><p>The method <code>utc</code> gives you the same datetime in the receiver expressed in UTC.</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
now = DateTime.current # =&gt; Mon, 07 Jun 2010 19:27:52 -0400
now.utc                # =&gt; Mon, 07 Jun 2010 23:27:52 +0000

</pre>
</div>
<p>This method is also aliased as <code>getutc</code>.</p><h6 id="utc-questionmark">16.1.2.3 <code>utc?</code>
</h6><p>The predicate <code>utc?</code> says whether the receiver has UTC as its time zone:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
now = DateTime.now # =&gt; Mon, 07 Jun 2010 19:30:47 -0400
now.utc?           # =&gt; false
now.utc.utc?       # =&gt; true

</pre>
</div>
<h6 id="other-extensions-advance">16.1.2.4 <code>advance</code>
</h6><p>The most generic way to jump to another datetime is <code>advance</code>. This method receives a hash with keys <code>:years</code>, <code>:months</code>, <code>:weeks</code>, <code>:days</code>, <code>:hours</code>, <code>:minutes</code>, and <code>:seconds</code>, and returns a datetime advanced as much as the present keys indicate.</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
d = DateTime.current
# =&gt; Thu, 05 Aug 2010 11:33:31 +0000
d.advance(years: 1, months: 1, days: 1, hours: 1, minutes: 1, seconds: 1)
# =&gt; Tue, 06 Sep 2011 12:34:32 +0000

</pre>
</div>
<p>This method first computes the destination date passing <code>:years</code>, <code>:months</code>, <code>:weeks</code>, and <code>:days</code> to <code>Date#advance</code> documented above. After that, it adjusts the time calling <code>since</code> with the number of seconds to advance. This order is relevant, a different ordering would give different datetimes in some edge-cases. The example in <code>Date#advance</code> applies, and we can extend it to show order relevance related to the time bits.</p><p>If we first move the date bits (that have also a relative order of processing, as documented before), and then the time bits we get for example the following computation:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
d = DateTime.new(2010, 2, 28, 23, 59, 59)
# =&gt; Sun, 28 Feb 2010 23:59:59 +0000
d.advance(months: 1, seconds: 1)
# =&gt; Mon, 29 Mar 2010 00:00:00 +0000

</pre>
</div>
<p>but if we computed them the other way around, the result would be different:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
d.advance(seconds: 1).advance(months: 1)
# =&gt; Thu, 01 Apr 2010 00:00:00 +0000

</pre>
</div>
<div class="warning"><p>Since <code>DateTime</code> is not DST-aware you can end up in a non-existing point in time with no warning or error telling you so.</p></div><h5 id="extensions-to-datetime-calculations-changing-components">16.1.3 Changing Components</h5><p>The method <code>change</code> allows you to get a new datetime which is the same as the receiver except for the given options, which may include <code>:year</code>, <code>:month</code>, <code>:day</code>, <code>:hour</code>, <code>:min</code>, <code>:sec</code>, <code>:offset</code>, <code>:start</code>:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
now = DateTime.current
# =&gt; Tue, 08 Jun 2010 01:56:22 +0000
now.change(year: 2011, offset: Rational(-6, 24))
# =&gt; Wed, 08 Jun 2011 01:56:22 -0600

</pre>
</div>
<p>If hours are zeroed, then minutes and seconds are too (unless they have given values):</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
now.change(hour: 0)
# =&gt; Tue, 08 Jun 2010 00:00:00 +0000

</pre>
</div>
<p>Similarly, if minutes are zeroed, then seconds are too (unless it has given a value):</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
now.change(min: 0)
# =&gt; Tue, 08 Jun 2010 01:00:00 +0000

</pre>
</div>
<p>This method is not tolerant to non-existing dates, if the change is invalid <code>ArgumentError</code> is raised:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
DateTime.current.change(month: 2, day: 30)
# =&gt; ArgumentError: invalid date

</pre>
</div>
<h5 id="extensions-to-datetime-calculations-durations">16.1.4 Durations</h5><p>Durations can be added to and subtracted from datetimes:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
now = DateTime.current
# =&gt; Mon, 09 Aug 2010 23:15:17 +0000
now + 1.year
# =&gt; Tue, 09 Aug 2011 23:15:17 +0000
now - 1.week
# =&gt; Mon, 02 Aug 2010 23:15:17 +0000

</pre>
</div>
<p>They translate to calls to <code>since</code> or <code>advance</code>. For example here we get the correct jump in the calendar reform:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
DateTime.new(1582, 10, 4, 23) + 1.hour
# =&gt; Fri, 15 Oct 1582 00:00:00 +0000

</pre>
</div>
<h3 id="extensions-to-time">17 Extensions to <code>Time</code>
</h3><h4 id="calculations">17.1 Calculations</h4><div class="note"><p>All the following methods are defined in <code>active_support/core_ext/time/calculations.rb</code>.</p></div><p>Active Support adds to <code>Time</code> many of the methods available for <code>DateTime</code>:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
past?
today?
future?
yesterday
tomorrow
seconds_since_midnight
change
advance
ago
since (in)
beginning_of_day (midnight, at_midnight, at_beginning_of_day)
end_of_day
beginning_of_hour (at_beginning_of_hour)
end_of_hour
beginning_of_week (at_beginning_of_week)
end_of_week (at_end_of_week)
monday
sunday
weeks_ago
prev_week (last_week)
next_week
months_ago
months_since
beginning_of_month (at_beginning_of_month)
end_of_month (at_end_of_month)
prev_month (last_month)
next_month
beginning_of_quarter (at_beginning_of_quarter)
end_of_quarter (at_end_of_quarter)
beginning_of_year (at_beginning_of_year)
end_of_year (at_end_of_year)
years_ago
years_since
prev_year (last_year)
next_year

</pre>
</div>
<p>They are analogous. Please refer to their documentation above and take into account the following differences:</p>
<ul>
<li>
<code>change</code> accepts an additional <code>:usec</code> option.</li>
<li>
<code>Time</code> understands DST, so you get correct DST calculations as in</li>
</ul>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
Time.zone_default
# =&gt; #&lt;ActiveSupport::TimeZone:0x7f73654d4f38 @utc_offset=nil, @name="Madrid", ...&gt;

# In Barcelona, 2010/03/28 02:00 +0100 becomes 2010/03/28 03:00 +0200 due to DST.
t = Time.local(2010, 3, 28, 1, 59, 59)
# =&gt; Sun Mar 28 01:59:59 +0100 2010
t.advance(seconds: 1)
# =&gt; Sun Mar 28 03:00:00 +0200 2010

</pre>
</div>

<ul>
<li>If <code>since</code> or <code>ago</code> jump to a time that can't be expressed with <code>Time</code> a <code>DateTime</code> object is returned instead.</li>
</ul>
<h5 id="time.current">17.1.1 <code>Time.current</code>
</h5><p>Active Support defines <code>Time.current</code> to be today in the current time zone. That's like <code>Time.now</code>, except that it honors the user time zone, if defined. It also defines the instance predicates <code>past?</code>, <code>today?</code>, and <code>future?</code>, all of them relative to <code>Time.current</code>.</p><p>When making Time comparisons using methods which honor the user time zone, make sure to use <code>Time.current</code> instead of <code>Time.now</code>. There are cases where the user time zone might be in the future compared to the system time zone, which <code>Time.now</code> uses by default. This means <code>Time.now.to_date</code> may equal <code>Date.yesterday</code>.</p><h5 id="all_day,-all_week,-all_month,-all_quarter-and-all_year">17.1.2 <code>all_day</code>, <code>all_week</code>, <code>all_month</code>, <code>all_quarter</code> and <code>all_year</code>
</h5><p>The method <code>all_day</code> returns a range representing the whole day of the current time.</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
now = Time.current
# =&gt; Mon, 09 Aug 2010 23:20:05 UTC +00:00
now.all_day
# =&gt; Mon, 09 Aug 2010 00:00:00 UTC +00:00..Mon, 09 Aug 2010 23:59:59 UTC +00:00

</pre>
</div>
<p>Analogously, <code>all_week</code>, <code>all_month</code>, <code>all_quarter</code> and <code>all_year</code> all serve the purpose of generating time ranges.</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
now = Time.current
# =&gt; Mon, 09 Aug 2010 23:20:05 UTC +00:00
now.all_week
# =&gt; Mon, 09 Aug 2010 00:00:00 UTC +00:00..Sun, 15 Aug 2010 23:59:59 UTC +00:00
now.all_week(:sunday)
# =&gt; Sun, 16 Sep 2012 00:00:00 UTC +00:00..Sat, 22 Sep 2012 23:59:59 UTC +00:00
now.all_month
# =&gt; Sat, 01 Aug 2010 00:00:00 UTC +00:00..Tue, 31 Aug 2010 23:59:59 UTC +00:00
now.all_quarter
# =&gt; Thu, 01 Jul 2010 00:00:00 UTC +00:00..Thu, 30 Sep 2010 23:59:59 UTC +00:00
now.all_year
# =&gt; Fri, 01 Jan 2010 00:00:00 UTC +00:00..Fri, 31 Dec 2010 23:59:59 UTC +00:00

</pre>
</div>
<h4 id="time-constructors">17.2 Time Constructors</h4><p>Active Support defines <code>Time.current</code> to be <code>Time.zone.now</code> if there's a user time zone defined, with fallback to <code>Time.now</code>:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
Time.zone_default
# =&gt; #&lt;ActiveSupport::TimeZone:0x7f73654d4f38 @utc_offset=nil, @name="Madrid", ...&gt;
Time.current
# =&gt; Fri, 06 Aug 2010 17:11:58 CEST +02:00

</pre>
</div>
<p>Analogously to <code>DateTime</code>, the predicates <code>past?</code>, and <code>future?</code> are relative to <code>Time.current</code>.</p><p>If the time to be constructed lies beyond the range supported by <code>Time</code> in the runtime platform, usecs are discarded and a <code>DateTime</code> object is returned instead.</p><h5 id="durations">17.2.1 Durations</h5><p>Durations can be added to and subtracted from time objects:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
now = Time.current
# =&gt; Mon, 09 Aug 2010 23:20:05 UTC +00:00
now + 1.year
#  =&gt; Tue, 09 Aug 2011 23:21:11 UTC +00:00
now - 1.week
# =&gt; Mon, 02 Aug 2010 23:21:11 UTC +00:00

</pre>
</div>
<p>They translate to calls to <code>since</code> or <code>advance</code>. For example here we get the correct jump in the calendar reform:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
Time.utc(1582, 10, 3) + 5.days
# =&gt; Mon Oct 18 00:00:00 UTC 1582

</pre>
</div>
<h3 id="extensions-to-file">18 Extensions to <code>File</code>
</h3><h4 id="atomic_write">18.1 <code>atomic_write</code>
</h4><p>With the class method <code>File.atomic_write</code> you can write to a file in a way that will prevent any reader from seeing half-written content.</p><p>The name of the file is passed as an argument, and the method yields a file handle opened for writing. Once the block is done <code>atomic_write</code> closes the file handle and completes its job.</p><p>For example, Action Pack uses this method to write asset cache files like <code>all.css</code>:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
File.atomic_write(joined_asset_path) do |cache|
  cache.write(join_asset_file_contents(asset_paths))
end

</pre>
</div>
<p>To accomplish this <code>atomic_write</code> creates a temporary file. That's the file the code in the block actually writes to. On completion, the temporary file is renamed, which is an atomic operation on POSIX systems. If the target file exists <code>atomic_write</code> overwrites it and keeps owners and permissions. However there are a few cases where <code>atomic_write</code> cannot change the file ownership or permissions, this error is caught and skipped over trusting in the user/filesystem to ensure the file is accessible to the processes that need it.</p><div class="note"><p>Due to the chmod operation <code>atomic_write</code> performs, if the target file has an ACL set on it this ACL will be recalculated/modified.</p></div><div class="warning"><p>Note you can't append with <code>atomic_write</code>.</p></div><p>The auxiliary file is written in a standard directory for temporary files, but you can pass a directory of your choice as second argument.</p><div class="note"><p>定义于 <code>active_support/core_ext/file/atomic.rb</code>.</p></div><h3 id="extensions-to-marshal">19 Extensions to <code>Marshal</code>
</h3><h4 id="load">19.1 <code>load</code>
</h4><p>Active Support adds constant autoloading support to <code>load</code>.</p><p>For example, the file cache store deserializes this way:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
File.open(file_name) { |f| Marshal.load(f) }

</pre>
</div>
<p>If the cached data refers to a constant that is unknown at that point, the autoloading mechanism is triggered and if it succeeds the deserialization is retried transparently.</p><div class="warning"><p>If the argument is an <code>IO</code> it needs to respond to <code>rewind</code> to be able to retry. Regular files respond to <code>rewind</code>.</p></div><div class="note"><p>定义于 <code>active_support/core_ext/marshal.rb</code>.</p></div><h3 id="extensions-to-logger">20 Extensions to <code>Logger</code>
</h3><h4 id="around_[level]">20.1 <code>around_[level]</code>
</h4><p>Takes two arguments, a <code>before_message</code> and <code>after_message</code> and calls the current level method on the <code>Logger</code> instance, passing in the <code>before_message</code>, then the specified message, then the <code>after_message</code>:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
logger = Logger.new("log/development.log")
logger.around_info("before", "after") { |logger| logger.info("during") }

</pre>
</div>
<h4 id="silence">20.2 <code>silence</code>
</h4><p>Silences every log level lesser to the specified one for the duration of the given block. Log level orders are: debug, info, error and fatal.</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
logger = Logger.new("log/development.log")
logger.silence(Logger::INFO) do
  logger.debug("In space, no one can hear you scream.")
  logger.info("Scream all you want, small mailman!")
end

</pre>
</div>
<h4 id="datetime_format=">20.3 <code>datetime_format=</code>
</h4><p>Modifies the datetime format output by the formatter class associated with this logger. If the formatter class does not have a <code>datetime_format</code> method then this is ignored.</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class Logger::FormatWithTime &lt; Logger::Formatter
  cattr_accessor(:datetime_format) { "%Y%m%d%H%m%S" }

  def self.call(severity, timestamp, progname, msg)
    "#{timestamp.strftime(datetime_format)} -- #{String === msg ? msg : msg.inspect}\n"
  end
end

logger = Logger.new("log/development.log")
logger.formatter = Logger::FormatWithTime
logger.info("&lt;- is the current time")

</pre>
</div>
<div class="note"><p>定义于 <code>active_support/core_ext/logger.rb</code>.</p></div><h3 id="extensions-to-nameerror">21 Extensions to <code>NameError</code>
</h3><p>Active Support adds <code>missing_name?</code> to <code>NameError</code>, which tests whether the exception was raised because of the name passed as argument.</p><p>The name may be given as a symbol or string. A symbol is tested against the bare constant name, a string is against the fully-qualified constant name.</p><div class="info"><p>A symbol can represent a fully-qualified constant name as in <code>:"ActiveRecord::Base"</code>, so the behavior for symbols is defined for convenience, not because it has to be that way technically.</p></div><p>For example, when an action of <code>ArticlesController</code> is called Rails tries optimistically to use <code>ArticlesHelper</code>. It is OK that the helper module does not exist, so if an exception for that constant name is raised it should be silenced. But it could be the case that <code>articles_helper.rb</code> raises a <code>NameError</code> due to an actual unknown constant. That should be reraised. The method <code>missing_name?</code> provides a way to distinguish both cases:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
def default_helper_module!
  module_name = name.sub(/Controller$/, '')
  module_path = module_name.underscore
  helper module_path
rescue MissingSourceFile =&gt; e
  raise e unless e.is_missing? "helpers/#{module_path}_helper"
rescue NameError =&gt; e
  raise e unless e.missing_name? "#{module_name}Helper"
end

</pre>
</div>
<div class="note"><p>定义于 <code>active_support/core_ext/name_error.rb</code>.</p></div><h3 id="extensions-to-loaderror">22 Extensions to <code>LoadError</code>
</h3><p>Active Support adds <code>is_missing?</code> to <code>LoadError</code>, and also assigns that class to the constant <code>MissingSourceFile</code> for backwards compatibility.</p><p>Given a path name <code>is_missing?</code> tests whether the exception was raised due to that particular file (except perhaps for the ".rb" extension).</p><p>For example, when an action of <code>ArticlesController</code> is called Rails tries to load <code>articles_helper.rb</code>, but that file may not exist. That's fine, the helper module is not mandatory so Rails silences a load error. But it could be the case that the helper module does exist and in turn requires another library that is missing. In that case Rails must reraise the exception. The method <code>is_missing?</code> provides a way to distinguish both cases:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
def default_helper_module!
  module_name = name.sub(/Controller$/, '')
  module_path = module_name.underscore
  helper module_path
rescue MissingSourceFile =&gt; e
  raise e unless e.is_missing? "helpers/#{module_path}_helper"
rescue NameError =&gt; e
  raise e unless e.missing_name? "#{module_name}Helper"
end

</pre>
</div>
<div class="note"><p>定义于 <code>active_support/core_ext/load_error.rb</code>.</p></div>

        <h3>反馈</h3>
        <p>
          欢迎帮忙改善指南质量。
        </p>
        <p>
          如发现任何错误，欢迎修正。开始贡献前，可先行阅读<a href="http://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation">贡献指南：文档</a>。
        </p>
        <p>翻译如有错误，深感抱歉，欢迎 <a href="https://github.com/ruby-china/guides/fork">Fork</a> 修正，或至此处<a href="https://github.com/ruby-china/guides/issues/new">回报</a>。</p>
        <p>
          文章可能有未完成或过时的内容。请先检查 <a href="http://edgeguides.rubyonrails.org">Edge Guides</a> 来确定问题在 master 是否已经修掉了。再上 master 补上缺少的文件。内容参考 <a href="ruby_on_rails_guides_guidelines.html">Ruby on Rails 指南准则</a>来了解行文风格。
        </p>
        <p>最后，任何关于 Ruby on Rails 文档的讨论，欢迎到 <a href="http://groups.google.com/group/rubyonrails-docs">rubyonrails-docs 邮件群组</a>。
        </p>
      </div>
    </div>
  </div>

  <hr class="hide" />
  <div id="footer">
    <div class="wrapper">
      <p>本著作采用<a href="https://creativecommons.org/licenses/by-sa/4.0/">创用 CC 姓名标示-相同方式分享 4.0 国际授权条款</a>授权。</p>
<p>“Rails”、“Ruby on Rails”，以及 Rails logo 为 David Heinemeier Hansson 的商标。版权所有。</p>

    </div>
  </div>

  <script type="text/javascript" src="javascripts/jquery.min.js"></script>
  <script type="text/javascript" src="javascripts/responsive-tables.js"></script>
  <script type="text/javascript" src="javascripts/guides.js"></script>
  <script type="text/javascript" src="javascripts/syntaxhighlighter/shCore.js"></script>
  <script type="text/javascript" src="javascripts/syntaxhighlighter/shBrushRuby.js"></script>
  <script type="text/javascript" src="javascripts/syntaxhighlighter/shBrushXml.js"></script>
  <script type="text/javascript" src="javascripts/syntaxhighlighter/shBrushSql.js"></script>
  <script type="text/javascript" src="javascripts/syntaxhighlighter/shBrushPlain.js"></script>
  <script type="text/javascript">
    SyntaxHighlighter.all();
    $(guidesIndex.bind);
  </script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    // ga('create', '', 'ruby-china.github.io');
    ga('require', 'displayfeatures');
    ga('send', 'pageview');

  </script>
</body>
</html>
